<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Noor Community Mentoring Program</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;800&family=Questrial&display=swap" rel="stylesheet">
    
    <!-- Animate.css for animations -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    
    <style>
        /* =====================================================================
           Organic Sage UI â€” Mobile-first, stable, and soothing
           Palette preserved; accessibility + mobile ergonomics improved.
           (Strictly adhering to provided CSS)
           ===================================================================== */

        /* ------------------------------- Design tokens ----------------------------------*/
        :root {
            --primary-sage: #7A8471;
            --secondary-sage: #9CAF88;
            --tertiary-sage: #B8C5A6;
            --warm-cream: #F8F6F0;
            --soft-white: #FEFCF7;
            --forest-shadow: #5A6B52;
            --border-sage: rgba(122, 132, 113, 0.20);
            --hover-sage: rgba(156, 175, 136, 0.15);

            --deep-forest: #3E4A3A;
            --moss: #6E7A67;
            --fern: #8FA081;
            --dried-clay: #D9CDB4;
            --amber: #C6AA77;
            --ink: #2F3A2B;
            --ink-muted: #5A6B52;

            --font-display: 'Questrial', system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, sans-serif;
            --font-body: 'Nunito', system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, sans-serif;

            --step--1: clamp(0.875rem, 0.84rem + 0.15vw, 0.95rem);
            --step-0: clamp(1rem, 0.96rem + 0.22vw, 1.1rem);
            --step-1: clamp(1.125rem, 1.07rem + 0.35vw, 1.3rem);
            --step-2: clamp(1.375rem, 1.28rem + 0.55vw, 1.6rem);
            --step-3: clamp(1.75rem, 1.58rem + 0.95vw, 2.1rem);
            --step-4: clamp(2.25rem, 1.98rem + 1.35vw, 2.7rem);

            --space-1: 0.25rem;
            --space-2: 0.5rem;
            --space-3: 0.75rem;
            --space-4: 1rem;
            --space-5: 1.25rem;
            --space-6: 1.5rem;
            --space-7: 2rem;
            --space-8: 2.5rem;
            --space-9: 3rem;

            --radius-sm: 10px;
            --radius: 16px;
            --radius-lg: 20px;
            --radius-xl: 28px;

            --shadow-1: 0 1px 2px rgba(34, 41, 32, 0.05), 0 2px 8px rgba(34, 41, 32, 0.06);
            --shadow-2: 0 4px 18px rgba(34, 41, 32, 0.08), 0 12px 28px rgba(34, 41, 32, 0.06);
            --shadow-3: 0 10px 40px rgba(34, 41, 32, 0.10), 0 20px 60px rgba(34, 41, 32, 0.08);

            --ring: 0 0 0 3px color-mix(in oklab, var(--soft-white) 60%, transparent), 0 0 0 5px color-mix(in srgb, var(--secondary-sage), #2F3A2B 15%);

            --ease-ambient: cubic-bezier(.2,.8,.2,1);
            --dur-1: 120ms;
            --dur-2: 200ms;
            --dur-3: 320ms;

            --target-min: 44px;
            --container-max: clamp(720px, 64vw, 1080px);
            --workspace-max: 1500px;
        }

        /* ------------------------------- Global reset / mobile stability ----------------------------------*/
        *, *::before, *::after { box-sizing: border-box; }
        html { -webkit-text-size-adjust: 100%; text-size-adjust: 100%; hanging-punctuation: first last; }
        html, body {
            margin: 0; padding: 0; width: 100%; min-height: 100dvh;
            font-family: var(--font-body); font-size: var(--step-0); line-height: 1.6;
            color: var(--forest-shadow);
            background: radial-gradient(1200px 1200px at -10% -10%, #FFFFFF 0%, transparent 50%),
                        radial-gradient(1200px 1000px at 110% 10%, #FFF8F0 0%, transparent 50%),
                        linear-gradient(135deg, #F8F6F0 0%, #F5F3ED 100%);
            -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; text-rendering: optimizeLegibility; overflow-x: hidden;
        }
        @media (prefers-reduced-motion: no-preference) { html { scroll-behavior: smooth; } }
        :where(p, h1, h2, h3, h4, h5, h6) { text-wrap: pretty; overflow-wrap: anywhere; }
        img, svg, video, canvas, audio, iframe { display: block; max-width: 100%; height: auto; }
        a { color: var(--primary-sage); text-decoration-thickness: 1px; text-underline-offset: 2px; }
        a:hover { color: var(--deep-forest); }
        .visually-hidden { position: absolute !important; height: 1px; width: 1px; overflow: hidden; clip: rect(1px, 1px, 1px, 1px); white-space: nowrap; }

        /* ------------------------------- App shell ----------------------------------*/
        #app-wrapper {
            display: flex; justify-content: center; align-items: stretch;
            padding: max(var(--space-7), env(safe-area-inset-top)) var(--space-4) var(--space-7);
            width: 100%; min-height: 100dvh;
            background: radial-gradient(800px 600px at 20% 0%, rgba(156,175,136,0.08) 0%, transparent 70%),
                        radial-gradient(700px 500px at 80% 100%, rgba(90,107,82,0.06) 0%, transparent 65%);
        }
        .skip-link {
            position: absolute;
            top: var(--space-3);
            left: 50%;
            transform: translate(-50%, -150%);
            background: var(--forest-shadow);
            color: #fff;
            padding: var(--space-2) var(--space-4);
            border-radius: var(--radius-sm);
            font-weight: 700;
            z-index: 1000;
            transition: transform var(--dur-1) var(--ease-ambient);
        }
        .skip-link:focus {
            transform: translate(-50%, 0);
        }
        #activity-shell {
            width: min(100%, var(--workspace-max));
            display: flex;
            flex-direction: column;
            gap: var(--space-6);
        }
        #activity-container {
            width: 100%; max-width: var(--container-max);
            background: color-mix(in srgb, var(--soft-white) 88%, white 12%);
            padding: clamp(24px, 3.2vw, 48px); border-radius: var(--radius-lg);
            border: 1px solid rgba(122, 132, 113, 0.12); box-shadow: var(--shadow-2);
            position: relative; isolation: isolate; container-type: inline-size;
        }
        @supports (backdrop-filter: blur(6px)) {
            #activity-container {
                background: color-mix(in srgb, var(--soft-white) 76%, white 24%);
                backdrop-filter: blur(6px) saturate(1.02);
            }
        }
        #activity-container::before {
            content: ""; position: absolute; inset: -1px; border-radius: inherit;
            background: radial-gradient(1200px 200px at 50% -5%, rgba(156,175,136,0.12), transparent 60%),
                        radial-gradient(800px 1000px at 50% 110%, rgba(122,132,113,0.08), transparent 70%);
            z-index: -1; pointer-events: none;
        }
        .screen { display: none; scroll-margin-top: clamp(90px, 12vh, 140px); } /* Hide screens initially */
        .screen.active { display: block; } /* Show active screen */

        /* ------------------------------- Interactive annotations ----------------------------------*/
        .highlight-annotation {
            background: color-mix(in srgb, var(--secondary-sage) 35%, white 65%);
            border-radius: var(--radius-sm);
            padding: 0 0.15em;
            cursor: pointer;
            transition: box-shadow var(--dur-1) var(--ease-ambient), background-color var(--dur-1) var(--ease-ambient);
            box-shadow: inset 0 -0.35em 0 rgba(198, 170, 119, 0.35);
            outline: none;
        }
        .highlight-annotation:focus-visible,
        .highlight-annotation:hover {
            box-shadow: inset 0 -0.35em 0 rgba(122, 132, 113, 0.4);
            background: color-mix(in srgb, var(--secondary-sage) 45%, white 55%);
        }
        .highlight-annotation[aria-expanded="true"] {
            box-shadow: inset 0 -0.35em 0 rgba(90, 107, 82, 0.45);
        }

        #highlight-toolbar {
            position: absolute;
            display: flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-2) var(--space-3);
            background: var(--soft-white);
            border: 1px solid var(--border-sage);
            border-radius: var(--radius-sm);
            box-shadow: var(--shadow-1);
            transform: translate(-50%, -120%);
            z-index: 2000;
            min-width: max-content;
        }
        #highlight-toolbar[hidden] {
            display: none;
        }
        .highlight-toolbar__btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
            font: inherit;
            background: var(--secondary-sage);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            padding: var(--space-2) var(--space-4);
            cursor: pointer;
            transition: background-color var(--dur-1) var(--ease-ambient), transform var(--dur-1) var(--ease-ambient);
        }
        .highlight-toolbar__btn:hover,
        .highlight-toolbar__btn:focus-visible {
            background: var(--forest-shadow);
        }
        .highlight-toolbar__btn:active {
            transform: scale(0.97);
        }

        .annotation-popover {
            position: absolute;
            max-width: min(320px, 80vw);
            padding: var(--space-4);
            background: var(--soft-white);
            border-radius: var(--radius);
            border: 1px solid var(--border-sage);
            box-shadow: var(--shadow-2);
            z-index: 2100;
            transform: translate(-50%, 0);
        }
        .annotation-popover[hidden] {
            display: none;
        }
        .annotation-popover::before {
            content: "";
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            border-width: 0 10px 10px 10px;
            border-style: solid;
            border-color: transparent transparent var(--soft-white) transparent;
        }
        .annotation-popover__close {
            background: none;
            border: none;
            color: var(--forest-shadow);
            position: absolute;
            top: var(--space-2);
            right: var(--space-2);
            cursor: pointer;
            padding: var(--space-1);
            border-radius: var(--radius-sm);
        }
        .annotation-popover__close:hover,
        .annotation-popover__close:focus-visible {
            background: var(--hover-sage);
        }
        .annotation-popover__body {
            margin: 0;
            font-size: var(--step-0);
            color: var(--forest-shadow);
        }

        .annotation-composer {
            position: absolute;
            width: min(340px, 82vw);
            padding: var(--space-4);
            background: var(--soft-white);
            border-radius: var(--radius);
            border: 1px solid var(--border-sage);
            box-shadow: var(--shadow-2);
            z-index: 2050;
            transform: translate(-50%, 0);
        }
        .annotation-composer[hidden] {
            display: none;
        }
        .annotation-composer__label {
            display: block;
            font-weight: 700;
            margin-bottom: var(--space-2);
            color: var(--forest-shadow);
        }
        .annotation-composer__input {
            width: 100%;
            min-height: 96px;
            padding: var(--space-3);
            border-radius: var(--radius-sm);
            border: 1px solid var(--border-sage);
            font: inherit;
            resize: vertical;
            background: color-mix(in srgb, var(--soft-white) 92%, white 8%);
            color: var(--forest-shadow);
        }
        .annotation-composer__input:focus-visible {
            outline: none;
            box-shadow: var(--ring);
            border-color: var(--secondary-sage);
        }
        .annotation-composer__actions {
            display: flex;
            justify-content: flex-end;
            gap: var(--space-2);
            margin-top: var(--space-3);
        }
        .annotation-composer__btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
            font: inherit;
            padding: var(--space-2) var(--space-4);
            border-radius: var(--radius-sm);
            border: none;
            cursor: pointer;
            transition: background-color var(--dur-1) var(--ease-ambient), transform var(--dur-1) var(--ease-ambient);
        }
        .annotation-composer__btn:hover,
        .annotation-composer__btn:focus-visible {
            transform: translateY(-1px);
        }
        .annotation-composer__btn:active {
            transform: scale(0.97);
        }
        .annotation-composer__btn--primary {
            background: var(--secondary-sage);
            color: white;
        }
        .annotation-composer__btn--primary:hover,
        .annotation-composer__btn--primary:focus-visible {
            background: var(--forest-shadow);
        }
        .annotation-composer__btn--secondary {
            background: transparent;
            color: var(--forest-shadow);
            border: 1px solid var(--border-sage);
        }
        .annotation-composer__btn--secondary:hover,
        .annotation-composer__btn--secondary:focus-visible {
            background: var(--hover-sage);
        }

        /* ------------------------------- Headings / text ----------------------------------*/
        h1 {
            font-family: var(--font-display); font-size: var(--step-4); letter-spacing: 0.2px;
            color: var(--forest-shadow); margin: 0 0 var(--space-2) 0; text-align: center;
        }
        h2.rubric {
            font-family: var(--font-body); font-size: var(--step-0); font-weight: 500;
            color: var(--secondary-sage); margin: 0 0 var(--space-6) 0; text-align: center; line-height: 1.5;
        }
        h3 {
            font-family: var(--font-display); font-size: var(--step-2); color: var(--forest-shadow);
            margin: var(--space-6) 0 var(--space-3) 0;
        }

        .presentation-header {
            position: sticky;
            top: 0;
            z-index: 2;
            background: linear-gradient(180deg, rgba(248, 246, 240, 0.92) 0%, rgba(248, 246, 240, 0.65) 85%, transparent 100%);
            backdrop-filter: blur(6px);
            padding: clamp(16px, 2vw, 24px);
            margin: calc(var(--space-6) * -1) calc(clamp(24px, 3.2vw, 48px) * -1) var(--space-4);
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
            border-bottom: 1px solid rgba(122, 132, 113, 0.12);
            box-shadow: 0 10px 25px rgba(62, 74, 58, 0.12);
        }
        .presentation-header__topline {
            display: flex;
            flex-wrap: wrap;
            align-items: flex-start;
            justify-content: space-between;
            gap: var(--space-4);
            margin-bottom: var(--space-3);
        }
        .presentation-header__identity {
            flex: 1 1 auto;
            min-width: 220px;
        }
        .presentation-header .presentation-eyebrow {
            font-size: var(--step--1);
            font-weight: 800;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: var(--primary-sage);
            margin: 0 0 var(--space-2) 0;
        }
        .presentation-descriptor {
            margin: 0;
            font-size: var(--step--1);
            color: var(--ink-muted);
            max-width: 60ch;
        }
        .lesson-selector {
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
            align-items: flex-start;
        }
        .lesson-selector label {
            font-size: var(--step--1);
            font-weight: 700;
            color: var(--forest-shadow);
        }
        .lesson-selector select {
            appearance: none;
            padding: var(--space-2) var(--space-4);
            border-radius: var(--radius-sm);
            border: 1px solid var(--border-sage);
            background: rgba(255, 255, 255, 0.9);
            font: inherit;
            color: var(--forest-shadow);
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.45);
            min-width: clamp(200px, 24vw, 260px);
        }
        .lesson-selector select:focus-visible {
            outline: none;
            box-shadow: var(--ring);
            border-color: var(--secondary-sage);
        }
        .presentation-menu {
            border-radius: var(--radius-lg);
            border: 1px solid rgba(122, 132, 113, 0.16);
            background: rgba(255, 255, 255, 0.85);
            box-shadow: 0 8px 22px rgba(62, 74, 58, 0.12);
            overflow: hidden;
        }
        .presentation-menu[open] {
            box-shadow: 0 18px 36px rgba(62, 74, 58, 0.18);
        }
        .presentation-menu__summary {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: var(--space-3);
            padding: var(--space-4);
            list-style: none;
            cursor: pointer;
            font-weight: 700;
            font-size: var(--step-0);
            color: var(--forest-shadow);
        }
        .presentation-menu__summary::-webkit-details-marker { display: none; }
        .presentation-menu__summary:focus-visible {
            outline: none;
            box-shadow: var(--ring);
        }
        .presentation-menu__summary-icon {
            font-size: var(--step-1);
            color: var(--primary-sage);
        }
        .presentation-menu__summary-label {
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }
        .presentation-menu__summary-hint {
            font-size: var(--step--1);
            color: var(--ink-muted);
        }
        .presentation-menu__content {
            padding: 0 var(--space-4) var(--space-4);
            display: grid;
            gap: var(--space-5);
        }
        .presentation-menu__card,
        .presentation-menu__section {
            display: grid;
            gap: var(--space-3);
        }
        .presentation-menu__card {
            padding: var(--space-4);
            background: color-mix(in srgb, var(--soft-white) 92%, #fff 8%);
            border: 1px solid var(--border-sage);
            border-radius: var(--radius);
            box-shadow: var(--shadow-1);
            grid-column: 1 / -1;
        }
        .presentation-menu__card-text {
            display: grid;
            gap: var(--space-2);
        }
        .presentation-menu__heading {
            margin: 0;
            font-size: var(--step--1);
            font-weight: 800;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: var(--primary-sage);
        }
        .presentation-menu__actions {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-3);
        }
        .presentation-menu__actions .activity-btn {
            min-height: 40px;
            padding: 8px 14px;
            font-size: 0.9rem;
            border-radius: 10px;
        }
        .presentation-menu__hint {
            margin: 0;
            font-size: var(--step--1);
            color: var(--ink-muted);
        }
        .presentation-menu__card .presentation-menu__hint {
            line-height: 1.5;
        }
        #slide-map { margin: 0; }
        #slide-map-list {
            display: flex;
            flex-direction: column;
            gap: var(--space-4);
            margin: 0;
            padding: 0;
            list-style: none;
        }
        .slide-map-group {
            display: flex;
            flex-direction: column;
            gap: var(--space-3);
        }
        .slide-map-group__title {
            margin: 0;
            font-size: var(--step-0);
            font-weight: 800;
            color: var(--forest-shadow);
            letter-spacing: 0.3px;
        }
        .slide-map-group__list {
            display: grid;
            gap: var(--space-2);
            margin: 0;
            padding: 0;
            list-style: none;
        }
        @container (min-width: 720px) {
            .slide-map-group__list {
                grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            }
        }
        .slide-map-item { min-width: 0; }
        .slide-map-button {
            border: 1px solid rgba(122, 132, 113, 0.25);
            background: rgba(255, 255, 255, 0.88);
            border-radius: var(--radius-sm);
            padding: var(--space-3);
            font-size: var(--step--1);
            font-weight: 600;
            color: var(--forest-shadow);
            cursor: pointer;
            display: grid;
            grid-template-columns: auto 1fr;
            align-items: center;
            gap: var(--space-3);
            width: 100%;
            min-height: var(--target-min);
            transition: transform var(--dur-1) var(--ease-ambient), box-shadow var(--dur-2) var(--ease-ambient), border-color var(--dur-2) var(--ease-ambient), background var(--dur-2) var(--ease-ambient);
            white-space: normal;
            overflow-wrap: anywhere;
            text-align: left;
        }
        .slide-map-button:hover,
        .slide-map-button:focus-visible {
            outline: none;
            transform: translateY(-1px);
            border-color: var(--secondary-sage);
            box-shadow: 0 6px 12px rgba(62, 74, 58, 0.15);
            background: color-mix(in srgb, var(--soft-white) 94%, white 6%);
        }
        .slide-map-item.is-active .slide-map-button {
            background: linear-gradient(180deg, color-mix(in srgb, var(--secondary-sage) 92%, white 8%), var(--secondary-sage));
            color: var(--soft-white);
            border-color: var(--secondary-sage);
            box-shadow: 0 6px 12px rgba(62, 74, 58, 0.18);
        }
        .slide-map-item.is-active .slide-map-button:hover,
        .slide-map-item.is-active .slide-map-button:focus-visible {
            transform: translateY(-1px);
        }
        .slide-map-button__number {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 999px;
            background: color-mix(in srgb, var(--secondary-sage) 25%, white 75%);
            color: var(--forest-shadow);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 0.95rem;
            letter-spacing: 0.3px;
        }
        .slide-map-button__label {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .slide-map-button__title {
            font-size: var(--step--1);
            font-weight: 700;
            color: inherit;
        }
        .slide-map-button__subtitle {
            font-size: 0.85rem;
            color: var(--ink-muted);
        }
        .slide-map-item.is-active .slide-map-button__number {
            background: color-mix(in srgb, var(--soft-white) 20%, var(--forest-shadow) 80%);
            color: var(--soft-white);
        }

        /* ------------------------------- Buttons ----------------------------------*/
        .activity-btn {
            min-height: var(--target-min); padding: 12px 20px; border-radius: 12px;
            border: 1px solid var(--primary-sage);
            background: linear-gradient(180deg, color-mix(in srgb, var(--primary-sage) 92%, white 8%), var(--primary-sage));
            color: #fff; font-weight: 700; font-size: 1rem; letter-spacing: 0.2px; cursor: pointer;
            text-decoration: none; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem;
            -webkit-tap-highlight-color: transparent; touch-action: manipulation; user-select: none;
            transition: transform var(--dur-1) var(--ease-ambient), box-shadow var(--dur-2) var(--ease-ambient), background var(--dur-2) var(--ease-ambient), border-color var(--dur-2) var(--ease-ambient), opacity var(--dur-1) var(--ease-ambient);
            box-shadow: 0 1px 0 rgba(255,255,255,0.25) inset, 0 8px 16px rgba(90, 107, 82, 0.20);
        }
        .activity-btn:hover {
            background: linear-gradient(180deg, color-mix(in srgb, var(--forest-shadow) 92%, white 8%), var(--forest-shadow));
            transform: translateY(-1px); box-shadow: 0 1px 0 rgba(255,255,255,0.25) inset, 0 10px 20px rgba(90, 107, 82, 0.22);
        }
        .activity-btn:active {
            transform: translateY(0); box-shadow: 0 1px 0 rgba(255,255,255,0.2) inset, 0 4px 10px rgba(90, 107, 82, 0.20);
        }
        .activity-btn:focus-visible { outline: none; box-shadow: var(--ring), 0 8px 16px rgba(90, 107, 82, 0.20); }
        .activity-btn:disabled, .activity-btn[disabled] {
            background: var(--tertiary-sage); border-color: var(--tertiary-sage);
            color: color-mix(in srgb, #fff 70%, var(--soft-white) 30%); cursor: not-allowed; opacity: 0.8; transform: none; box-shadow: none;
        }
        .activity-btn.secondary {
            background: transparent; color: var(--primary-sage); border-color: color-mix(in srgb, var(--tertiary-sage) 70%, var(--primary-sage) 30%); box-shadow: none;
        }
        .activity-btn.secondary:hover { background-color: var(--hover-sage); }
        .activity-btn.secondary:focus-visible { outline: none; box-shadow: var(--ring); }
        .controls { margin-top: var(--space-7); text-align: center; display: grid; gap: var(--space-3); grid-auto-flow: row; }

        /* ------------------------------- Forms / inputs ----------------------------------*/
        .input-group { margin: var(--space-6) 0; }
        .input-group label { display: block; font-weight: 700; margin-bottom: var(--space-2); color: var(--primary-sage); letter-spacing: 0.2px; }
        input[type="text"], input[type="date"], textarea, select {
            width: 100%; min-height: var(--target-min); padding: 12px 14px; border-radius: 10px;
            border: 1px solid var(--tertiary-sage); background: #fff; font-size: 1rem; font-family: var(--font-body);
            color: var(--ink); box-shadow: 0 1px 0 rgba(255,255,255,0.6) inset; appearance: none; -webkit-appearance: none;
            transition: border-color var(--dur-2) var(--ease-ambient), box-shadow var(--dur-2) var(--ease-ambient), background var(--dur-2) var(--ease-ambient);
        }
        input::placeholder, textarea::placeholder { color: color-mix(in srgb, var(--ink-muted) 60%, #fff 40%); opacity: 0.9; }
        input:focus-visible, textarea:focus-visible, select:focus-visible {
            outline: none; border-color: var(--secondary-sage); box-shadow: var(--ring);
            background: color-mix(in srgb, #fff 92%, var(--warm-cream) 8%);
        }
        input:disabled, textarea:disabled, select:disabled {
            background: color-mix(in srgb, #fff 85%, var(--warm-cream) 15%); color: var(--ink-muted); cursor: not-allowed;
        }
        input[type="date"] { -webkit-tap-highlight-color: transparent; }
        textarea { resize: vertical; }
        :root { accent-color: var(--primary-sage); }

        /* ------------------------------- Responsive / container queries ----------------------------------*/
        @media (min-width: 768px) {
            #app-wrapper { padding-inline: var(--space-7); }
            .controls { grid-auto-flow: column; justify-content: center; }
            .presentation-menu__content { grid-template-columns: repeat(2, minmax(0, 1fr)); }
            .presentation-menu__actions { justify-content: flex-start; }
        }
        @media (min-width: 1024px) {
            #activity-container { box-shadow: var(--shadow-3); }
            h1 { letter-spacing: 0.3px; }
            .presentation-header { padding: clamp(20px, 2.4vw, 32px) clamp(28px, 3.2vw, 48px); margin: calc(var(--space-6) * -1) calc(clamp(28px, 3.2vw, 48px) * -1) var(--space-5); }
            #slide-map-list { gap: var(--space-4); }
        }
        @media (max-width: 767px) {
            #app-wrapper { padding: var(--space-4); }
            #activity-container { padding: 24px; }
            h1 { font-size: clamp(1.75rem, 5vw, 2rem); }
            h2.rubric { font-size: var(--step--1); margin-bottom: 20px; }
            .slide-map-button { padding-inline: var(--space-3); }
            .presentation-header__topline { flex-direction: column; align-items: stretch; }
            .lesson-selector { width: 100%; }
            .lesson-selector select { width: 100%; min-width: 0; }
        }

        /* ------------------------------- Accessibility / motion / scroll ----------------------------------*/
        :focus-visible { outline: none; box-shadow: var(--ring); }
        @media (prefers-reduced-motion: reduce) { * { animation: none !important; transition: none !important; scroll-behavior: auto !important; } }
        ::selection { background: color-mix(in srgb, var(--secondary-sage) 30%, #fff 70%); color: var(--deep-forest); }
        html, body { overscroll-behavior-y: none; }

        /* ------------------------------- Scrollbars (subtle, optional) ----------------------------------*/
        *::-webkit-scrollbar { width: 10px; height: 10px; }
        *::-webkit-scrollbar-thumb { background: color-mix(in srgb, var(--primary-sage) 50%, var(--tertiary-sage) 50%); border-radius: 999px; border: 2px solid transparent; background-clip: padding-box; }
        *::-webkit-scrollbar-track { background: transparent; }

        /* ------------------------------- Dark mode (gentle, earthy) ----------------------------------*/
        @media (prefers-color-scheme: dark) {
            :root {
                --soft-white: #1E211C; --warm-cream: #23261F; --forest-shadow: #DDE6D4;
                --ink: #E9EFE5; --ink-muted: #AEB9AA; --border-sage: rgba(184, 197, 166, 0.25);
            }
            html, body {
                background: radial-gradient(1100px 900px at 15% 10%, rgba(156,175,136,0.06), transparent 60%),
                            radial-gradient(900px 900px at 85% 90%, rgba(122,132,113,0.08), transparent 65%),
                            linear-gradient(135deg, #191D18 0%, #1B1E19 100%);
            }
            #activity-container { background: color-mix(in srgb, #23261F 92%, #1B1E19 8%); border-color: rgba(184, 197, 166, 0.18); box-shadow: 0 12px 36px rgba(0,0,0,0.35); }
            .presentation-header { background: linear-gradient(180deg, rgba(31, 33, 28, 0.92) 0%, rgba(31, 33, 28, 0.6) 85%, transparent 100%); border-bottom-color: rgba(184, 197, 166, 0.2); }
            .presentation-menu { background: rgba(28, 31, 26, 0.88); border-color: rgba(184, 197, 166, 0.28); box-shadow: 0 16px 32px rgba(0,0,0,0.35); }
            .presentation-menu__summary { color: var(--forest-shadow); }
            .presentation-menu__summary-icon { color: color-mix(in srgb, var(--secondary-sage) 80%, #0F120E 20%); }
            .presentation-menu__hint { color: color-mix(in srgb, var(--ink-muted) 85%, #fff 15%); }
            .lesson-selector label { color: var(--forest-shadow); }
            .lesson-selector select { background: rgba(28, 31, 26, 0.85); border-color: rgba(184, 197, 166, 0.28); color: var(--forest-shadow); box-shadow: none; }
            a { color: color-mix(in srgb, var(--secondary-sage) 80%, #C7D3C0 20%); }
            .mc-question { background: linear-gradient(180deg, #20241E 0%, #191D18 100%); border-color: rgba(184, 197, 166, 0.20); box-shadow: 0 1px 0 rgba(255,255,255,0.03) inset, 0 10px 30px rgba(0,0,0,0.35); }
            .activity-btn { background: linear-gradient(180deg, color-mix(in srgb, var(--primary-sage) 80%, #0F120E 20%), var(--primary-sage)); box-shadow: 0 1px 0 rgba(255,255,255,0.08) inset, 0 8px 18px rgba(0,0,0,0.35); }
            .activity-btn:hover { background: linear-gradient(180deg, color-mix(in srgb, var(--forest-shadow) 80%, #0F120E 20%), var(--forest-shadow)); }
            input, textarea, select { background: #141713; border-color: rgba(184, 197, 166, 0.25); color: var(--ink); }
            .notes-dock-header { background: rgba(28, 31, 26, 0.78); border-color: rgba(184, 197, 166, 0.28); box-shadow: 0 12px 28px rgba(0,0,0,0.35); }
            .notes-dock-subtitle { color: color-mix(in srgb, var(--ink-muted) 85%, #fff 15%); }
            .slide-map-group__title { color: color-mix(in srgb, var(--secondary-sage) 70%, #C7D3C0 30%); }
            .slide-map-button { background: rgba(28, 31, 26, 0.75); border-color: rgba(184, 197, 166, 0.28); color: var(--forest-shadow); }
            .slide-map-button__number { background: color-mix(in srgb, var(--secondary-sage) 55%, #0F120E 45%); color: var(--soft-white); }
            .slide-map-button__subtitle { color: color-mix(in srgb, var(--ink-muted) 80%, #fff 20%); }
            .slide-map-item.is-active .slide-map-button { background: linear-gradient(180deg, color-mix(in srgb, var(--secondary-sage) 85%, #0F120E 15%), var(--secondary-sage)); color: var(--soft-white); border-color: color-mix(in srgb, var(--secondary-sage) 85%, #0F120E 15%); }
            .slide-map-item.is-active .slide-map-button__number { background: color-mix(in srgb, var(--soft-white) 15%, var(--forest-shadow) 85%); }
            .textbox-color-picker { background: rgba(28, 31, 26, 0.75); border-color: rgba(184, 197, 166, 0.28); }
            .textbox-color-picker__swatch { border-color: rgba(184, 197, 166, 0.28); }
            .textbox-color-picker__swatch.is-selected { box-shadow: 0 0 0 3px rgba(20, 23, 19, 0.85), 0 0 0 5px rgba(184, 197, 166, 0.35); }
        }

        /* ------------------------------- Slide-specific styles ----------------------------------*/
        /* Custom styles for the presentation content */
        .slide-content { margin-top: var(--space-6); }
        .slide-content img {
            width: 100%;
            height: 250px;
            object-fit: cover;
            border-radius: var(--radius);
            margin-bottom: var(--space-6);
        }
        .slide-list {
            list-style: none;
            padding-left: 0;
            margin-bottom: var(--space-6);
        }
        .slide-list li {
            position: relative;
            padding-left: var(--space-7);
            margin-bottom: var(--space-4);
            font-size: var(--step-1);
            line-height: 1.5;
        }
        .slide-list li::before {
            content: "";
            position: absolute;
            left: 0;
            top: var(--space-1);
            width: var(--space-3);
            height: var(--space-3);
            background-color: var(--primary-sage);
            border-radius: 50%;
        }
        .slide-list.smart li::before {
            content: attr(data-letter);
            background-color: var(--secondary-sage);
            color: var(--soft-white);
            font-weight: 700;
            font-size: var(--step--1);
            text-align: center;
            line-height: var(--space-7);
        }
        .process-flow {
            display: grid;
            gap: var(--space-4);
        }
        .process-step {
            display: flex;
            align-items: center;
            gap: var(--space-4);
            padding: var(--space-4);
            border-radius: var(--radius-sm);
            border: 1px solid var(--border-sage);
            background: #fff;
        }
        .process-step-number {
            font-family: var(--font-display);
            font-size: var(--step-3);
            color: var(--primary-sage);
            font-weight: 700;
            flex-shrink: 0;
            width: 50px;
            text-align: center;
        }
        .process-step-content {
            font-size: var(--step-0);
        }
        .process-step-content strong { color: var(--forest-shadow); }

        /* Navigation controls styling */
        .navigation {
            display: flex;
            justify-content: space-between;
            margin-top: var(--space-7);
        }
        .navigation button {
            width: 150px;
        }
        .navigation button:first-child { justify-content: flex-start; }
        .navigation button:last-child { justify-content: flex-end; }

        .slide-content p { margin-bottom: var(--space-4); }
        .slide-content ul { padding-left: var(--space-6); }
        .slide-content ul li { margin-bottom: var(--space-2); }
        
        .card-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--space-4);
            margin-top: var(--space-6);
        }
        .card {
            background: #fff;
            border: 1px solid var(--border-sage);
            border-radius: var(--radius);
            padding: var(--space-5);
            box-shadow: var(--shadow-1);
            text-align: center;
        }
        .card .icon {
            font-size: var(--step-3);
            color: var(--primary-sage);
            margin-bottom: var(--space-3);
        }
        .card h3 {
            font-size: var(--step-1);
            margin: 0;
        }
        .quiz-card {
            background: var(--warm-cream);
            border: 1px solid var(--border-sage);
            border-radius: var(--radius);
            padding: var(--space-5);
            margin-bottom: var(--space-5);
            display: flex;
            flex-direction: column;
            gap: var(--space-4);
        }
        .quiz-question-text {
            font-weight: 700;
            font-size: var(--step-1);
            color: var(--forest-shadow);
            margin: 0;
        }
        .quiz-options {
            display: flex;
            flex-direction: column;
            gap: var(--space-3);
        }
        .quiz-option {
            display: flex;
            align-items: flex-start;
            gap: var(--space-3);
            padding: var(--space-3);
            border: 1px solid rgba(122, 132, 113, 0.18);
            border-radius: var(--radius-sm);
            background: color-mix(in srgb, var(--soft-white) 92%, white 8%);
            transition: background var(--dur-2) var(--ease-ambient), transform var(--dur-1) var(--ease-ambient);
        }
        .quiz-option:hover {
            background: var(--hover-sage);
            transform: translateY(-1px);
        }
        .quiz-option input[type="radio"] {
            margin-top: 4px;
        }
        .quiz-option span {
            flex: 1;
        }
        .activity-btn.quiz-btn {
            align-self: flex-start;
            background: linear-gradient(180deg, color-mix(in srgb, var(--secondary-sage) 92%, white 8%), var(--secondary-sage));
            border-color: var(--secondary-sage);
            color: var(--soft-white);
        }
        .activity-btn.quiz-btn:hover {
            background: linear-gradient(180deg, color-mix(in srgb, var(--forest-shadow) 88%, white 12%), var(--forest-shadow));
        }
        .quiz-feedback {
            margin: 0;
            font-weight: 600;
        }
        .quiz-feedback.correct {
            color: var(--secondary-sage);
        }
        .quiz-feedback.incorrect {
            color: #C4665A;
        }
        .quiz-feedback.notice {
            color: var(--forest-shadow);
        }
        .reflection-form {
            display: grid;
            gap: var(--space-5);
        }
        .reflection-field label {
            display: block;
            font-weight: 700;
            color: var(--forest-shadow);
            margin-bottom: var(--space-2);
        }
        .reflection-field textarea {
            width: 100%;
            min-height: 120px;
            padding: var(--space-4);
            border-radius: var(--radius-sm);
            border: 1px solid rgba(122, 132, 113, 0.28);
            background: color-mix(in srgb, var(--soft-white) 92%, white 8%);
            font-family: var(--font-body);
            font-size: var(--step-0);
            resize: vertical;
        }
        /* ------------------------------- Collaborative text boxes ----------------------------------*/
        #notes-dock {
            width: 100%;
            background: color-mix(in srgb, var(--soft-white) 90%, white 10%);
            border-radius: var(--radius-lg);
            border: 1px solid rgba(122, 132, 113, 0.14);
            box-shadow: var(--shadow-1);
            padding: clamp(20px, 2.8vw, 32px);
            display: flex;
            flex-direction: column;
            gap: var(--space-5);
            min-height: 0;
        }
        .notes-dock-header {
            display: grid;
            gap: var(--space-2);
            padding: var(--space-4);
            border-radius: var(--radius);
            border: 1px solid rgba(122, 132, 113, 0.16);
            background: color-mix(in srgb, var(--soft-white) 94%, white 6%);
            box-shadow: var(--shadow-1);
        }
        .notes-dock-title {
            margin: 0;
            font-family: var(--font-display);
            font-size: var(--step-1);
            color: var(--forest-shadow);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }
        .notes-dock-subtitle {
            margin: 0;
            font-size: var(--step--1);
            color: var(--ink-muted);
        }
        #notes-panels {
            display: flex;
            flex-direction: column;
            gap: var(--space-4);
            flex: 1 1 auto;
            min-height: 0;
        }
        .notes-panel {
            display: none;
            flex-direction: column;
            gap: var(--space-4);
            background: color-mix(in srgb, var(--soft-white) 96%, white 4%);
            border: 1px solid rgba(122, 132, 113, 0.14);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            box-shadow: var(--shadow-1);
        }
        .notes-panel.active {
            display: flex;
        }
        .notes-panel-title {
            margin: 0;
            font-family: var(--font-display);
            font-size: var(--step-1);
            color: var(--forest-shadow);
        }
        .textbox-toolbar {
            margin-top: var(--space-6);
            margin-bottom: var(--space-3);
            padding: var(--space-3);
            border-radius: var(--radius-sm);
            border: 1px solid rgba(122, 132, 113, 0.18);
            background: color-mix(in srgb, var(--soft-white) 94%, white 6%);
            display: flex;
            flex-direction: column;
            gap: var(--space-3);
        }
        .textbox-swatch-group {
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }
        .textbox-swatch-group button {
            width: 38px;
            height: 38px;
            border-radius: 50%;
            border: 2px solid rgba(62, 74, 58, 0.15);
            background: var(--swatch-color);
            cursor: pointer;
            transition: transform var(--dur-1) var(--ease-ambient), box-shadow var(--dur-2) var(--ease-ambient), border-color var(--dur-2) var(--ease-ambient);
        }
        .textbox-swatch-group button:hover {
            transform: translateY(-1px);
            border-color: rgba(62, 74, 58, 0.3);
            box-shadow: 0 6px 12px rgba(62, 74, 58, 0.15);
        }
        .textbox-swatch-group button:focus-visible {
            outline: none;
            box-shadow: var(--ring), 0 6px 12px rgba(62, 74, 58, 0.18);
        }
        .textbox-toolbar .toolbar-caption {
            margin: 0;
            font-size: var(--step--1);
            color: var(--ink-muted);
        }
        .notes-panel .textbox-toolbar {
            margin-top: 0;
            margin-bottom: 0;
        }
        .textbox-collection {
            display: grid;
            gap: var(--space-3);
        }
        .notes-panel .textbox-collection {
            min-width: 0;
        }
        .custom-textbox {
            position: relative;
            border-radius: var(--radius);
            padding: var(--space-4);
            box-shadow: var(--shadow-1);
            border: 1px solid rgba(0, 0, 0, 0.05);
            color: #1F2B1B;
        }
        .custom-textbox .textbox-content {
            min-height: 80px;
            outline: none;
            font-family: var(--font-body);
            font-size: var(--step-0);
            line-height: 1.5;
        }
        .custom-textbox .textbox-content:empty::before {
            content: attr(data-placeholder);
            color: rgba(47, 58, 43, 0.5);
        }
        .textbox-actions {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-3);
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-3);
        }
        .textbox-color-picker {
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            padding: 6px 10px;
            border-radius: var(--radius-sm);
            border: 1px solid rgba(122, 132, 113, 0.18);
            background: rgba(255, 255, 255, 0.65);
        }
        .textbox-color-picker__swatch {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 2px solid rgba(62, 74, 58, 0.18);
            background: var(--swatch-color);
            cursor: pointer;
            transition: transform var(--dur-1) var(--ease-ambient), box-shadow var(--dur-2) var(--ease-ambient), border-color var(--dur-2) var(--ease-ambient);
        }
        .textbox-color-picker__swatch:hover {
            transform: translateY(-1px);
            border-color: rgba(62, 74, 58, 0.32);
            box-shadow: 0 6px 12px rgba(62, 74, 58, 0.16);
        }
        .textbox-color-picker__swatch:focus-visible {
            outline: none;
            box-shadow: var(--ring), 0 6px 12px rgba(62, 74, 58, 0.2);
        }
        .textbox-color-picker__swatch.is-selected {
            border-color: rgba(62, 74, 58, 0.45);
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.8), 0 0 0 5px rgba(62, 74, 58, 0.25);
        }
        .textbox-remove-btn {
            border: none;
            background: transparent;
            color: var(--forest-shadow);
            font-weight: 700;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .textbox-remove-btn:hover {
            color: #C4665A;
        }
        @media (max-width: 767px) {
            .textbox-toolbar {
                align-items: stretch;
            }
            .textbox-swatch-group {
                flex-wrap: wrap;
            }
            .textbox-actions {
                flex-direction: column;
                align-items: stretch;
            }
            .textbox-remove-btn {
                justify-content: center;
            }
        }
        @media (min-width: 992px) {
            #activity-shell {
                flex-direction: row;
                align-items: flex-start;
                gap: var(--space-7);
            }
            #activity-container {
                flex: 1 1 auto;
                max-width: none;
            }
            #notes-dock {
                flex: 0 0 clamp(280px, 30vw, 360px);
                position: sticky;
                top: clamp(1.5rem, 4vw, 3rem);
                max-height: calc(100vh - clamp(1.5rem, 4vw, 3rem));
                overflow: hidden;
            }
            #notes-panels {
                overflow: auto;
                padding-right: var(--space-1);
            }
        }
        .animate-on-scroll {
            opacity: 0;
        }
    </style>
</head>
<body>

    <a class="skip-link" href="#activity-container">Skip to presentation content</a>

    <div id="app-wrapper">
        <main id="activity-shell" role="main">
            <div id="activity-container">

            <header class="presentation-header" id="presentation-header">
                <div class="presentation-header__topline">
                    <div class="presentation-header__identity">
                        <p class="presentation-eyebrow" id="presentation-eyebrow">Instructional Session</p>
                        <p class="presentation-descriptor" id="presentation-descriptor">Choose a template to populate the slides.</p>
                    </div>
                    <div class="lesson-selector">
                        <label for="lesson-template">Lesson template</label>
                        <select id="lesson-template" aria-label="Select a lesson template"></select>
                    </div>
                </div>
                <details class="presentation-menu" id="notes-io-controls" open>
                    <summary class="presentation-menu__summary">
                        <span class="presentation-menu__summary-label">
                            <i class="fas fa-seedling presentation-menu__summary-icon" aria-hidden="true"></i>
                            Session tools
                        </span>
                        <span class="presentation-menu__summary-hint">Slide map &amp; notes backup</span>
                    </summary>
                    <div class="presentation-menu__content">
                        <section class="presentation-menu__card" aria-labelledby="presentation-notes-io-heading">
                            <div class="presentation-menu__card-text">
                                <h2 class="presentation-menu__heading" id="presentation-notes-io-heading">Save or load notes</h2>
                                <p class="presentation-menu__hint">Download your current slide text boxes or import a saved copy.</p>
                            </div>
                            <div class="presentation-menu__actions">
                                <button type="button" class="activity-btn secondary" id="save-notes-btn"><i class="fas fa-file-arrow-down"></i> Save Notes (JSON)</button>
                                <button type="button" class="activity-btn secondary" id="load-notes-btn"><i class="fas fa-file-arrow-up"></i> Load Notes (JSON)</button>
                            </div>
                            <input type="file" id="notes-file-input" accept="application/json" hidden>
                        </section>
                        <section class="presentation-menu__section" aria-labelledby="presentation-slide-map-heading">
                            <h2 class="presentation-menu__heading" id="presentation-slide-map-heading">Slide map</h2>
                            <nav id="slide-map" aria-label="Slide overview">
                                <ul id="slide-map-list"></ul>
                            </nav>
                        </section>
                    </div>
                </details>
            </header>

                <div id="slides-root" role="presentation"></div>

        </div>
        <aside id="notes-dock" aria-label="Collaborative slide notes workspace">
            <div class="notes-dock-header">
                <p class="notes-dock-title"><i class="fas fa-note-sticky" aria-hidden="true"></i> Slide Text Boxes</p>
                <p class="notes-dock-subtitle">Use the session tools foldout to save or load your notes at any time.</p>
            </div>
            <div id="notes-panels" aria-live="polite"></div>
        </aside>
    </main>
    </div>

    <script>
        const lessonLibrary = {
            mentoringOrientation: {
                id: "mentoring-orientation",
                label: "Mentoring orientation",
                meta: {
                    eyebrow: "Noor Community Mentoring",
                    descriptor: "An onboarding deck for project-based mentoring partnerships.",
                    pageTitle: "Mentoring Orientation â€“ Instructional Slides"
                },
                sections: [
                    { title: "Welcome & Community", slideKeys: ["welcome", "mentoring-benefits", "community-identity", "mentoring-definition"] },
                    { title: "Opportunities & Stories", slideKeys: ["mentoring-outcomes", "mission-quiz", "project-cv", "project-speaking"] },
                    { title: "Planning Framework", slideKeys: ["smart-framework", "smart-example", "journey-steps", "journey-quiz"] },
                    { title: "Commitment & Care", slideKeys: ["commitments", "commitment-quiz"] },
                    { title: "Next Steps", slideKeys: ["brainstorm", "reflection"] }
                ],
                slides: [
                    {
                        key: "welcome",
                        type: "hero",
                        title: "Welcome to the Noor Community Mentoring Program",
                        subtitle: "Building a supportive future, together.",
                        image: {
                            src: "https://images.pexels.com/photos/3184418/pexels-photo-3184418.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1",
                            alt: "Diverse team collaborating in a bright, modern office"
                        },
                        nav: { hidePrev: true, nextLabel: "Start", nextIcon: "fas fa-play" }
                    },
                    {
                        key: "mentoring-benefits",
                        type: "content",
                        icon: "fas fa-cogs",
                        title: "Benefits of Mentoring (Soft Skills)",
                        image: {
                            src: "https://images.pexels.com/photos/1595385/pexels-photo-1595385.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1",
                            alt: "A group of people collaborating and brainstorming around a table"
                        },
                        body: [
                            "Mentoring is a powerful tool for personal and professional growth. It can help you develop a wide range of soft skills that support success in any field."
                        ],
                        list: [
                            "Improved communication and interpersonal skills",
                            "Enhanced leadership and decision-making abilities",
                            "Increased confidence and self-awareness",
                            "Greater problem-solving and critical thinking skills"
                        ]
                    },
                    {
                        key: "community-identity",
                        type: "content",
                        icon: "fas fa-users",
                        title: "Who Are We?",
                        image: {
                            src: "https://images.pexels.com/photos/3183150/pexels-photo-3183150.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1",
                            alt: "A diverse group of colleagues celebrating a success together"
                        },
                        body: [
                            "The Noor Community is an educational space dedicated to liberation through learning. We believe in solidarity and social justice.",
                            "Our goal is to create a safe environment where everyone can express themselves, develop their skills, and connect with others. We see learning and teaching as universal processes that empower all of us."
                        ]
                    },
                    {
                        key: "mentoring-definition",
                        type: "content",
                        icon: "fas fa-hands-helping",
                        title: "What Is Mentoring?",
                        image: {
                            src: "https://images.pexels.com/photos/5668859/pexels-photo-5668859.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1",
                            alt: "A mentor guiding a mentee at a computer"
                        },
                        body: [
                            "Mentoring is a collaborative relationship where an experienced person supports another learner to develop skills and reach their goals.",
                            "Our approach centres trust and empowerment. Mentors act as guides who celebrate wins, ask thoughtful questions, and help you stay accountable to your project vision."
                        ]
                    },
                    {
                        key: "mentoring-outcomes",
                        type: "cards",
                        icon: "fas fa-lightbulb",
                        title: "What Becomes Possible?",
                        subtitle: "Mentoring can help you achieve concrete, practical outcomes.",
                        cards: [
                            { icon: "fas fa-file-alt", title: "CV & LinkedIn" },
                            { icon: "fas fa-microphone", title: "Public Speaking" },
                            { icon: "fas fa-award", title: "Grant Proposals" },
                            { icon: "fas fa-graduation-cap", title: "University Applications" }
                        ]
                    },
                    {
                        key: "mission-quiz",
                        type: "quiz",
                        icon: "fas fa-question-circle",
                        title: "Quick Check: Our Mission & Mentoring",
                        questions: [
                            {
                                id: "mission-q1",
                                prompt: "What is the Noor Community primarily committed to?",
                                options: [
                                    { value: "solidarity", label: "Building solidarity and working toward social justice through education." },
                                    { value: "competition", label: "Organising competitive events that reward the top performers only." },
                                    { value: "online-only", label: "Delivering self-paced online courses without community interaction." }
                                ],
                                answer: "solidarity",
                                correctFeedback: "Exactly! Our community centres solidarity and social justice.",
                                incorrectFeedback: "Review our visionâ€”connection and justice are at the heart of Noor Community."
                            },
                            {
                                id: "mission-q2",
                                prompt: "How does the mentoring relationship operate in this program?",
                                options: [
                                    { value: "hierarchy", label: "The mentor gives orders and the mentee follows a fixed set of tasks." },
                                    { value: "collaboration", label: "Mentor and mentee collaborate to reach the menteeâ€™s goals through trust and guidance." },
                                    { value: "assessment", label: "The mentor grades the mentee each week on quizzes and exams." }
                                ],
                                answer: "collaboration",
                                correctFeedback: "Yes! Mentoring here is a collaborative, empowering partnership.",
                                incorrectFeedback: "Rememberâ€”the mentor is a guide who supports, not a judge or taskmaster."
                            }
                        ]
                    },
                    {
                        key: "project-cv",
                        type: "story",
                        icon: "fas fa-user-tie",
                        title: "Project Story: Developing a CV",
                        quote: "\"I needed a strong CV to apply for work.\"",
                        image: {
                            src: "https://images.pexels.com/photos/590022/pexels-photo-590022.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1",
                            alt: "A person writing a CV at a desk"
                        },
                        process: {
                            label: "The Process:",
                            text: "Laila partnered with her mentor to identify key skills, choose powerful action verbs, and organise her experience into a compelling narrative."
                        },
                        outcome: {
                            label: "The Outcome:",
                            text: "She now has a polished CV that highlights her strengths and feels confident applying for new opportunities."
                        }
                    },
                    {
                        key: "project-speaking",
                        type: "story",
                        icon: "fas fa-podium-star",
                        title: "Project Story: Public Speaking",
                        quote: "\"I was nervous about giving presentations.\"",
                        image: {
                            src: "https://images.pexels.com/photos/1181406/pexels-photo-1181406.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1",
                            alt: "A person giving a presentation to an audience"
                        },
                        process: {
                            label: "The Process:",
                            text: "Mariam practised weekly with her mentor, using recordings to reflect on pacing, body language, and clarity."
                        },
                        outcome: {
                            label: "The Outcome:",
                            text: "She delivered a confident presentation and built a repeatable routine for future talks."
                        }
                    },
                    {
                        key: "smart-framework",
                        type: "content",
                        icon: "fas fa-bullseye",
                        title: "Create a Measurable Project",
                        image: {
                            src: "https://images.pexels.com/photos/853151/pexels-photo-853151.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1",
                            alt: "A group of people working together to achieve a goal"
                        },
                        body: [
                            "Successful projects require clear goals. To make sure your project is effective, we use the SMART framework.",
                            "This approach keeps outcomes measurable and realistic for a three-month partnership."
                        ],
                        listStyle: "smart",
                        list: [
                            { letter: "S", text: "Specific" },
                            { letter: "M", text: "Measurable" },
                            { letter: "A", text: "Achievable" },
                            { letter: "R", text: "Relevant" },
                            { letter: "T", text: "Time-bound" }
                        ]
                    },
                    {
                        key: "smart-example",
                        type: "content",
                        icon: "fas fa-check-circle",
                        title: "Example: A SMART Goal",
                        image: {
                            src: "https://images.pexels.com/photos/598917/pexels-photo-598917.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1",
                            alt: "A person writing in a notebook"
                        },
                        body: [
                            "Consider the broad goal: \"I want to improve my CV.\"",
                            "To make it SMART, add clear actions and a deadline: \"I will update my CV to describe three key skills with evidence and finish by the end of this month.\""
                        ]
                    },
                    {
                        key: "journey-steps",
                        type: "process",
                        icon: "fas fa-rocket",
                        title: "Project Journey Milestones",
                        subtitle: "Refine your idea, match with a mentor, and plan together.",
                        image: {
                            src: "https://images.pexels.com/photos/8386440/pexels-photo-8386440.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1",
                            alt: "A person interacting with an AI assistant"
                        },
                        body: [
                            "Each mentoring partnership moves through three steady stages."
                        ],
                        steps: [
                            { title: "Step 1: AI Guide", description: "Use our planning tool to turn your idea into a detailed SMART proposal." },
                            { title: "Step 2: Mentor Matching", description: "We review your project and pair you with someone whose expertise aligns with your goals." },
                            { title: "Step 3: First Meeting", description: "You and your mentor set expectations and map out weekly tasks for the coming months." }
                        ]
                    },
                    {
                        key: "journey-quiz",
                        type: "quiz",
                        icon: "fas fa-route",
                        title: "Quick Check: Journey Steps",
                        questions: [
                            {
                                id: "journey-q1",
                                prompt: "What happens right after you submit your project proposal?",
                                options: [
                                    { value: "matching", label: "The team reviews it and pairs you with a mentor whose experience fits your goal." },
                                    { value: "presentation", label: "You immediately present your project to the whole community." },
                                    { value: "budget", label: "You complete reimbursement paperwork for supplies." }
                                ],
                                answer: "matching",
                                correctFeedback: "Correctâ€”the team reviews your plan and matches you with the right mentor.",
                                incorrectFeedback: "Not quite. Review the journey slides to see what happens post-submission."
                            },
                            {
                                id: "journey-q2",
                                prompt: "What is the focus of the first mentor meeting?",
                                options: [
                                    { value: "weekly-plan", label: "Co-creating detailed weekly steps and agreeing on expectations." },
                                    { value: "celebration", label: "Celebrating the final results of your project." },
                                    { value: "reporting", label: "Submitting monthly reports to the admin team." }
                                ],
                                answer: "weekly-plan",
                                correctFeedback: "Exactly! The first meeting sets the shared weekly plan.",
                                incorrectFeedback: "Check the milestone slideâ€”the first session is about planning, not reporting yet."
                            }
                        ]
                    },
                    {
                        key: "commitments",
                        type: "content",
                        icon: "fas fa-clock",
                        title: "Time Commitment & Boundaries",
                        image: {
                            src: "https://images.pexels.com/photos/4348403/pexels-photo-4348403.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1",
                            alt: "A person working at a desk with a clock in the background"
                        },
                        list: [
                            { icon: "fas fa-calendar-alt", strong: "Project Duration:", text: "The project is designed to be completed in three months." },
                            { icon: "fas fa-hourglass-half", strong: "Mentor Time:", text: "Mentors allocate up to one hour each week for check-ins and feedback." },
                            { icon: "fas fa-plus-circle", strong: "Contingency:", text: "If needed, you can request a one-month extension to complete final pieces." }
                        ]
                    },
                    {
                        key: "commitment-quiz",
                        type: "quiz",
                        icon: "fas fa-user-shield",
                        title: "Quick Check: Commitments & Care",
                        questions: [
                            {
                                id: "care-q1",
                                prompt: "How long is each weekly mentoring session designed to last?",
                                options: [
                                    { value: "thirty", label: "About 30 minutes focused on reflection and planning." },
                                    { value: "sixty", label: "Exactly 60 minutes with required presentations." },
                                    { value: "drop-in", label: "No set timeâ€”mentees drop in and out at any point." }
                                ],
                                answer: "thirty",
                                correctFeedback: "Great! Weekly check-ins are focused, 30-minute conversations.",
                                incorrectFeedback: "Take another lookâ€”the program keeps meetings short and consistent."
                            },
                            {
                                id: "care-q2",
                                prompt: "What happens if a mentee misses three sessions in a row without an acceptable reason?",
                                options: [
                                    { value: "bonus", label: "They receive extra time with their mentor to catch up." },
                                    { value: "hold", label: "The project is placed on hold until the mentee is ready to re-engage." },
                                    { value: "replacement", label: "They are automatically assigned a new mentor." }
                                ],
                                answer: "hold",
                                correctFeedback: "Correctâ€”the project pauses so mentees can return when ready.",
                                incorrectFeedback: "Review the boundaries slide; consistency keeps the partnership active."
                            }
                        ]
                    },
                    {
                        key: "brainstorm",
                        type: "content",
                        icon: "fas fa-lightbulb",
                        title: "Next Steps: Brainstorming",
                        subtitle: "Letâ€™s surface your ideas and questions.",
                        image: {
                            src: "https://images.pexels.com/photos/3184465/pexels-photo-3184465.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1",
                            alt: "A group of people brainstorming with sticky notes"
                        },
                        body: [
                            "Take a moment to share any project ideas already on your mind.",
                            "Weâ€™ll spend the next 20 minutes using the AI guide tool to draft initial proposals.",
                            "Bring forward any questions about the mentoring process or your concept."
                        ]
                    },
                    {
                        key: "reflection",
                        type: "reflection",
                        icon: "fas fa-pen-to-square",
                        title: "Reflection & Planning Notes",
                        fields: [
                            { id: "mentoring-idea", label: "Project idea I want to explore", placeholder: "Capture the community challenge or opportunity you care about." },
                            { id: "mentoring-smart", label: "First SMART-aligned step I can take", placeholder: "Draft a Specific, Measurable action you can complete soon." },
                            { id: "mentoring-questions", label: "Questions I want to ask my mentor", placeholder: "List the support, resources, or feedback you hope to receive." }
                        ],
                        nav: { nextAction: "restart", nextLabel: "Finish & Restart", nextIcon: "fas fa-check" }
                    }
                ]
            },
            eltLesson: {
                id: "elt-lesson-template",
                label: "ELT descriptive language lesson",
                meta: {
                    eyebrow: "English Language Teaching",
                    descriptor: "Reusable slide flow for communicative ELT lessons focused on descriptive language.",
                    pageTitle: "ELT Lesson Template â€“ Instructional Slides"
                },
                sections: [
                    { title: "Welcome & Objectives", slideKeys: ["elt-hero", "elt-objectives", "elt-warmups"] },
                    { title: "Language Focus", slideKeys: ["elt-vocabulary", "elt-vocab-quiz", "elt-modeling"] },
                    { title: "Lesson Flow", slideKeys: ["elt-lesson-flow", "elt-assessment"] },
                    { title: "Practice & Reflection", slideKeys: ["elt-group-work", "elt-reflection"] }
                ],
                slides: [
                    {
                        key: "elt-hero",
                        type: "hero",
                        title: "Exploring Descriptive Language",
                        subtitle: "An adaptable lesson template for upper-intermediate learners.",
                        image: {
                            src: "https://images.pexels.com/photos/3184298/pexels-photo-3184298.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1",
                            alt: "Students collaborating at a table with notebooks"
                        },
                        nav: { hidePrev: true, nextLabel: "Begin", nextIcon: "fas fa-play" }
                    },
                    {
                        key: "elt-objectives",
                        type: "content",
                        icon: "fas fa-bullseye",
                        title: "Lesson Objectives",
                        image: {
                            src: "https://images.pexels.com/photos/3184328/pexels-photo-3184328.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1",
                            alt: "Teacher leading a discussion with adult learners"
                        },
                        body: [
                            "Set clear language targets before class begins so everyone understands the journey.",
                            "Use this template to communicate goals in seconds."],
                        list: [
                            "Activate prior knowledge about vivid descriptions.",
                            "Practise using sensory adjectives and strong verbs.",
                            "Produce a short description that shows voice and detail."
                        ]
                    },
                    {
                        key: "elt-warmups",
                        type: "cards",
                        icon: "fas fa-sun",
                        title: "Warm-Up Options",
                        subtitle: "Choose a quick engagement to open class.",
                        cards: [
                            { icon: "fas fa-image", title: "Picture Prompt", description: "Display an image and ask learners to list adjectives." },
                            { icon: "fas fa-comments", title: "Two Truths", description: "Learners share two descriptive sentencesâ€”one must be imaginary." },
                            { icon: "fas fa-music", title: "Sound Walk", description: "Play ambient audio and brainstorm vocabulary for what is heard." },
                            { icon: "fas fa-lightbulb", title: "Word Association", description: "Start with a noun and build a descriptive chain together." }
                        ]
                    },
                    {
                        key: "elt-vocabulary",
                        type: "content",
                        icon: "fas fa-book-open",
                        title: "Vocabulary Focus",
                        image: {
                            src: "https://images.pexels.com/photos/5428832/pexels-photo-5428832.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1",
                            alt: "Close-up of hands writing vocabulary notes"
                        },
                        body: [
                            "Model a short descriptive paragraph and highlight the language choices that make it vivid.",
                            "Encourage learners to notice collocations and the rhythm created by varied sentence lengths."
                        ],
                        list: [
                            "Contrast plain versus evocative adjectives.",
                            "Collect verb-noun partnerships that add energy.",
                            "Flag discourse markers that guide the reader." ]
                    },
                    {
                        key: "elt-vocab-quiz",
                        type: "quiz",
                        icon: "fas fa-spell-check",
                        title: "Quick Check: Vocabulary Moves",
                        questions: [
                            {
                                id: "elt-vocab-q1",
                                prompt: "Which sentence uses sensory detail most effectively?",
                                options: [
                                    { value: "plain", label: "The market was busy and people talked." },
                                    { value: "vivid", label: "The market buzzed with voices and citrus peels perfumed the air." },
                                    { value: "short", label: "The market was there." }
                                ],
                                answer: "vivid",
                                correctFeedback: "Yesâ€”the vivid option layers sound and smell to engage readers.",
                                incorrectFeedback: "Try again. Look for language that appeals to multiple senses."
                            },
                            {
                                id: "elt-vocab-q2",
                                prompt: "Why is it helpful to collect verbâ€“noun partnerships during the lesson?",
                                options: [
                                    { value: "variety", label: "They help learners vary phrasing and avoid repeating basic verbs." },
                                    { value: "length", label: "They guarantee every sentence is longer." },
                                    { value: "grammar", label: "They replace the need to review grammar structures." }
                                ],
                                answer: "variety",
                                correctFeedback: "Exactlyâ€”collocations give learners ready-to-use alternatives.",
                                incorrectFeedback: "Remember, collecting pairs supports expressive variety, not sentence length." }
                        ]
                    },
                    {
                        key: "elt-modeling",
                        type: "story",
                        icon: "fas fa-chalkboard-teacher",
                        title: "Teacher Modeling",
                        quote: "\"Letâ€™s paint the scene together.\"",
                        image: {
                            src: "https://images.pexels.com/photos/3184312/pexels-photo-3184312.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1",
                            alt: "Teacher presenting vocabulary on a whiteboard"
                        },
                        process: {
                            label: "Approach:",
                            text: "The teacher thinks aloud while drafting a descriptive paragraph, highlighting word choice decisions." },
                        outcome: {
                            label: "Learner Impact:",
                            text: "Students see how to revise dull phrases and feel confident trying the routine themselves." }
                    },
                    {
                        key: "elt-lesson-flow",
                        type: "process",
                        icon: "fas fa-layer-group",
                        title: "Lesson Flow",
                        subtitle: "Structure the experience around gradual release.",
                        image: {
                            src: "https://images.pexels.com/photos/3184287/pexels-photo-3184287.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1",
                            alt: "Learners working collaboratively at a table"
                        },
                        steps: [
                            { title: "Engage", description: "Activate prior knowledge with a warm-up and set the scene." },
                            { title: "Explore Language", description: "Analyse model texts, highlight vocabulary, and notice patterns." },
                            { title: "Guided Practice", description: "Co-construct sentences and offer quick feedback." },
                            { title: "Independent Production", description: "Learners craft their own description and share with peers." }
                        ]
                    },
                    {
                        key: "elt-assessment",
                        type: "content",
                        icon: "fas fa-clipboard-list",
                        title: "Assessment & Evidence",
                        image: {
                            src: "https://images.pexels.com/photos/1181370/pexels-photo-1181370.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1",
                            alt: "Teacher reviewing student work with sticky notes"
                        },
                        body: [
                            "Collect lightweight evidence throughout the lesson to track growth and plan next steps."
                        ],
                        list: [
                            "Use observation checklists during guided practice.",
                            "Invite learners to submit a short exit description or voice note.",
                            "Facilitate peer feedback focusing on descriptive language goals." ]
                    },
                    {
                        key: "elt-group-work",
                        type: "content",
                        icon: "fas fa-users",
                        title: "Collaborative Practice",
                        subtitle: "Rotate roles so everyone speaks and supports.",
                        image: {
                            src: "https://images.pexels.com/photos/3182833/pexels-photo-3182833.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1",
                            alt: "Small group of learners discussing around a table"
                        },
                        body: [
                            "Assign trios with roles: narrator, detail detective, and tone coach.",
                            "After each round, rotate roles and swap prompts to maximise practice." ]
                    },
                    {
                        key: "elt-reflection",
                        type: "reflection",
                        icon: "fas fa-pen-to-square",
                        title: "Teacher Planning Notes",
                        fields: [
                            { id: "elt-focus", label: "Focus language point", placeholder: "Note the adjectives, verbs, or discourse markers you want to emphasise." },
                            { id: "elt-context", label: "Real-life scenario", placeholder: "Describe the context or text type learners will connect to." },
                            { id: "elt-followup", label: "Follow-up idea", placeholder: "Capture homework, extension, or differentiation options." }
                        ],
                        nav: { nextAction: "restart", nextLabel: "Finish & Restart", nextIcon: "fas fa-check" }
                    }
                ]
            }
        };
        const textboxColorOptions = [
            { label: "Sunlit Sand", value: "#FDF5D6" },
            { label: "Mint Mist", value: "#E6F4F1" },
            { label: "Lavender Veil", value: "#F3E9FB" },
            { label: "Peach Glow", value: "#FFEDE5" },
            { label: "Sky Wash", value: "#E9F0FF" }
        ];

        const storageKeyBase = "instructional-slide-textboxes";
        let activeLessonKey = null;
        let activeLesson = null;
        let slides = [];
        let currentSlideIndex = 0;
        let slideNotes = {};
        const textboxContainers = {};
        const notesPanels = {};
        let notesPanelsHost = null;
        const slideMapButtons = [];
        let keyboardHandlerAttached = false;

        const slidesRoot = document.getElementById("slides-root");
        const presentationEyebrow = document.getElementById("presentation-eyebrow");
        const presentationDescriptor = document.getElementById("presentation-descriptor");
        const lessonSelector = document.getElementById("lesson-template");
        const slideMapList = document.getElementById("slide-map-list");
        const motionQuery = typeof window !== "undefined" && window.matchMedia ? window.matchMedia("(prefers-reduced-motion: reduce)") : null;
        let prefersReducedMotion = motionQuery ? motionQuery.matches : false;

        const highlightScope = document.getElementById("activity-container");
        const highlightToolbar = document.createElement("div");
        highlightToolbar.id = "highlight-toolbar";
        highlightToolbar.setAttribute("role", "group");
        highlightToolbar.setAttribute("aria-label", "Text annotation tools");
        highlightToolbar.setAttribute("aria-hidden", "true");
        highlightToolbar.hidden = true;

        const highlightToolbarButton = document.createElement("button");
        highlightToolbarButton.type = "button";
        highlightToolbarButton.className = "highlight-toolbar__btn";
        highlightToolbarButton.innerHTML = '<i class="fas fa-highlighter" aria-hidden="true"></i><span>Highlight &amp; annotate</span>';
        highlightToolbar.appendChild(highlightToolbarButton);
        document.body.appendChild(highlightToolbar);

        const annotationPopover = document.createElement("div");
        annotationPopover.className = "annotation-popover";
        annotationPopover.id = "annotation-popover";
        annotationPopover.setAttribute("role", "dialog");
        annotationPopover.setAttribute("aria-modal", "false");
        annotationPopover.setAttribute("aria-hidden", "true");
        annotationPopover.hidden = true;
        annotationPopover.setAttribute("tabindex", "-1");

        const annotationCloseButton = document.createElement("button");
        annotationCloseButton.type = "button";
        annotationCloseButton.className = "annotation-popover__close";
        annotationCloseButton.innerHTML = '<i class="fas fa-times" aria-hidden="true"></i><span class="visually-hidden">Close annotation</span>';

        const annotationBody = document.createElement("p");
        annotationBody.className = "annotation-popover__body";

        annotationPopover.appendChild(annotationCloseButton);
        annotationPopover.appendChild(annotationBody);
        document.body.appendChild(annotationPopover);

        const annotationComposer = document.createElement("form");
        annotationComposer.className = "annotation-composer";
        annotationComposer.id = "annotation-composer";
        annotationComposer.hidden = true;
        annotationComposer.setAttribute("aria-hidden", "true");
        annotationComposer.setAttribute("role", "dialog");
        annotationComposer.setAttribute("aria-modal", "false");
        annotationComposer.noValidate = true;

        const annotationComposerLabel = document.createElement("label");
        annotationComposerLabel.className = "annotation-composer__label";
        annotationComposerLabel.setAttribute("for", "annotation-composer-input");
        annotationComposerLabel.textContent = "Add an annotation";
        annotationComposerLabel.id = "annotation-composer-label";
        annotationComposer.setAttribute("aria-labelledby", "annotation-composer-label");

        const annotationComposerTextarea = document.createElement("textarea");
        annotationComposerTextarea.id = "annotation-composer-input";
        annotationComposerTextarea.className = "annotation-composer__input";
        annotationComposerTextarea.rows = 4;
        annotationComposerTextarea.placeholder = "Type your note hereâ€¦";

        const annotationComposerActions = document.createElement("div");
        annotationComposerActions.className = "annotation-composer__actions";

        const annotationComposerCancel = document.createElement("button");
        annotationComposerCancel.type = "button";
        annotationComposerCancel.className = "annotation-composer__btn annotation-composer__btn--secondary";
        annotationComposerCancel.textContent = "Cancel";

        const annotationComposerSubmit = document.createElement("button");
        annotationComposerSubmit.type = "submit";
        annotationComposerSubmit.className = "annotation-composer__btn annotation-composer__btn--primary";
        annotationComposerSubmit.textContent = "Save note";

        annotationComposerActions.appendChild(annotationComposerCancel);
        annotationComposerActions.appendChild(annotationComposerSubmit);

        annotationComposer.appendChild(annotationComposerLabel);
        annotationComposer.appendChild(annotationComposerTextarea);
        annotationComposer.appendChild(annotationComposerActions);
        document.body.appendChild(annotationComposer);

        let pendingSelectionRange = null;
        let activeAnnotationTarget = null;
        let composerActiveRange = null;

        if (motionQuery) {
            const updatePreference = (event) => {
                prefersReducedMotion = event.matches;
                const activeSlide = slides[currentSlideIndex];
                if (activeSlide) {
                    animateSlideContents(activeSlide);
                }
            };
            if (typeof motionQuery.addEventListener === "function") {
                motionQuery.addEventListener("change", updatePreference);
            } else if (typeof motionQuery.addListener === "function") {
                motionQuery.addListener(updatePreference);
            }
        }
        function isNodeWithinActiveSlide(node) {
            const activeSlide = slides[currentSlideIndex];
            if (!activeSlide || !node) {
                return false;
            }
            let current = node.nodeType === Node.ELEMENT_NODE ? node : node.parentNode;
            while (current) {
                if (current === activeSlide) {
                    return true;
                }
                current = current.parentNode;
            }
            return false;
        }

        function isInsideExistingHighlight(node) {
            if (!node) {
                return false;
            }
            const element = node.nodeType === Node.ELEMENT_NODE ? node : node.parentElement;
            return element ? Boolean(element.closest(".highlight-annotation")) : false;
        }

        function hideHighlightToolbar(options = {}) {
            const { clearSelection = true } = options;
            if (highlightToolbar.hidden) {
                return;
            }
            highlightToolbar.hidden = true;
            highlightToolbar.setAttribute("aria-hidden", "true");
            if (clearSelection) {
                pendingSelectionRange = null;
            }
        }

        function positionHighlightToolbar(range) {
            const rect = range.getBoundingClientRect();
            const top = window.scrollY + rect.top;
            const left = window.scrollX + rect.left + rect.width / 2;
            highlightToolbar.style.top = `${Math.max(top, 0)}px`;
            highlightToolbar.style.left = `${left}px`;
        }

        function isRangeAnnotatable(range) {
            if (!range || range.collapsed) {
                return false;
            }
            if (!isNodeWithinActiveSlide(range.startContainer) || !isNodeWithinActiveSlide(range.endContainer)) {
                return false;
            }
            if (isInsideExistingHighlight(range.startContainer) || isInsideExistingHighlight(range.endContainer)) {
                return false;
            }
            const fragment = range.cloneContents();
            if (fragment.querySelector && fragment.querySelector("p, li, div, section, article, ul, ol, table, tr, td, th, h1, h2, h3, h4, h5, h6, blockquote")) {
                return false;
            }
            return range.toString().trim().length > 0;
        }

        function showHighlightToolbar(range) {
            pendingSelectionRange = range.cloneRange();
            positionHighlightToolbar(range);
            highlightToolbar.hidden = false;
            highlightToolbar.setAttribute("aria-hidden", "false");
        }

        function positionAnnotationComposer(range) {
            const rect = range.getBoundingClientRect();
            const top = window.scrollY + rect.bottom + 12;
            const left = window.scrollX + rect.left + rect.width / 2;
            annotationComposer.style.top = `${Math.max(top, 0)}px`;
            annotationComposer.style.left = `${left}px`;
        }

        function openAnnotationComposer(range) {
            if (!range) {
                return;
            }
            composerActiveRange = range.cloneRange();
            positionAnnotationComposer(range);
            annotationComposer.hidden = false;
            annotationComposer.setAttribute("aria-hidden", "false");
            annotationComposerTextarea.value = "";
            window.requestAnimationFrame(() => {
                annotationComposerTextarea.focus({ preventScroll: true });
            });
        }

        function closeAnnotationComposer({ restoreToolbar = false, clearRange = true } = {}) {
            if (!annotationComposer.hidden) {
                annotationComposer.hidden = true;
                annotationComposer.setAttribute("aria-hidden", "true");
                annotationComposerTextarea.value = "";
            }
            if (clearRange) {
                composerActiveRange = null;
            }
            if (restoreToolbar && pendingSelectionRange) {
                showHighlightToolbar(pendingSelectionRange);
            }
        }

        function updateHighlightToolbar() {
            const selection = window.getSelection();
            if (!selection || selection.rangeCount === 0) {
                hideHighlightToolbar();
                return;
            }
            const range = selection.getRangeAt(0);
            if (!isRangeAnnotatable(range)) {
                hideHighlightToolbar();
                return;
            }
            hideAnnotationPopover();
            showHighlightToolbar(range);
        }

        function hideAnnotationPopover() {
            if (annotationPopover.hidden) {
                return;
            }
            annotationPopover.hidden = true;
            annotationPopover.setAttribute("aria-hidden", "true");
            if (activeAnnotationTarget) {
                activeAnnotationTarget.setAttribute("aria-expanded", "false");
                activeAnnotationTarget = null;
            }
        }

        function positionAnnotationPopover(target) {
            const rect = target.getBoundingClientRect();
            const top = window.scrollY + rect.bottom + 12;
            const left = window.scrollX + rect.left + rect.width / 2;
            annotationPopover.style.top = `${top}px`;
            annotationPopover.style.left = `${left}px`;
        }

        function showAnnotationPopover(target) {
            const annotationText = target?.dataset?.annotation;
            if (!annotationText) {
                hideAnnotationPopover();
                return;
            }
            if (activeAnnotationTarget && activeAnnotationTarget !== target) {
                activeAnnotationTarget.setAttribute("aria-expanded", "false");
            }
            activeAnnotationTarget = target;
            annotationBody.textContent = annotationText;
            positionAnnotationPopover(target);
            annotationPopover.hidden = false;
            annotationPopover.setAttribute("aria-hidden", "false");
            target.setAttribute("aria-expanded", "true");
        }

        function toggleAnnotationPopover(target) {
            if (annotationPopover.hidden || target !== activeAnnotationTarget) {
                showAnnotationPopover(target);
            } else {
                hideAnnotationPopover();
            }
        }

        function applyAnnotation(range, annotationText) {
            if (!range) {
                return;
            }
            const trimmed = annotationText.trim();
            if (!trimmed) {
                return;
            }
            const workingRange = range.cloneRange();
            const highlight = document.createElement("mark");
            highlight.className = "highlight-annotation";
            highlight.tabIndex = 0;
            highlight.setAttribute("role", "button");
            highlight.setAttribute("aria-expanded", "false");
            highlight.setAttribute("aria-controls", "annotation-popover");
            highlight.setAttribute("aria-haspopup", "dialog");
            highlight.dataset.annotation = trimmed;
            const contents = workingRange.extractContents();
            highlight.appendChild(contents);
            workingRange.insertNode(highlight);
            highlight.normalize();
            if (highlight.parentNode) {
                highlight.parentNode.normalize();
            }
            const selection = window.getSelection();
            if (selection) {
                selection.removeAllRanges();
            }
            hideHighlightToolbar();
            window.requestAnimationFrame(() => {
                showAnnotationPopover(highlight);
                highlight.focus({ preventScroll: true });
            });
        }

        highlightToolbarButton.addEventListener("mousedown", (event) => {
            event.preventDefault();
        });

        highlightToolbarButton.addEventListener("click", () => {
            if (!pendingSelectionRange) {
                hideHighlightToolbar();
                closeAnnotationComposer();
                return;
            }
            const rangeToAnnotate = pendingSelectionRange.cloneRange();
            hideHighlightToolbar({ clearSelection: false });
            openAnnotationComposer(rangeToAnnotate);
        });

        annotationComposer.addEventListener("submit", (event) => {
            event.preventDefault();
            if (!composerActiveRange) {
                closeAnnotationComposer();
                hideHighlightToolbar();
                return;
            }
            const note = annotationComposerTextarea.value.trim();
            if (!note) {
                annotationComposerTextarea.focus({ preventScroll: true });
                return;
            }
            const rangeToAnnotate = composerActiveRange.cloneRange();
            closeAnnotationComposer();
            applyAnnotation(rangeToAnnotate, note);
        });

        annotationComposerCancel.addEventListener("click", () => {
            closeAnnotationComposer({ restoreToolbar: true });
        });

        annotationCloseButton.addEventListener("click", () => {
            hideAnnotationPopover();
            if (activeAnnotationTarget) {
                activeAnnotationTarget.focus({ preventScroll: true });
            }
        });

        document.addEventListener("selectionchange", () => {
            const activeElement = document.activeElement;
            if (!annotationComposer.hidden && annotationComposer.contains(activeElement)) {
                return;
            }
            closeAnnotationComposer();
            window.requestAnimationFrame(updateHighlightToolbar);
        });

        document.addEventListener("mousedown", (event) => {
            const isToolbar = highlightToolbar.contains(event.target);
            const isComposer = annotationComposer.contains(event.target);
            if (!isToolbar && !isComposer) {
                hideHighlightToolbar();
                closeAnnotationComposer();
            }
        });

        document.addEventListener("click", (event) => {
            if (!annotationPopover.hidden) {
                const isHighlight = event.target.closest?.(".highlight-annotation");
                const isPopover = annotationPopover.contains(event.target);
                if (!isHighlight && !isPopover) {
                    hideAnnotationPopover();
                }
            }
            if (!annotationComposer.hidden) {
                const isComposer = annotationComposer.contains(event.target);
                if (!isComposer && !highlightToolbar.contains(event.target)) {
                    closeAnnotationComposer();
                    hideHighlightToolbar();
                }
            }
        });

        document.addEventListener("keydown", (event) => {
            if (event.key === "Escape") {
                hideAnnotationPopover();
                hideHighlightToolbar();
                closeAnnotationComposer();
            }
        });

        if (highlightScope) {
            highlightScope.addEventListener("click", (event) => {
                const highlight = event.target.closest?.(".highlight-annotation");
                if (!highlight) {
                    return;
                }
                event.preventDefault();
                hideHighlightToolbar();
                toggleAnnotationPopover(highlight);
            });

            highlightScope.addEventListener("keydown", (event) => {
                if (event.key !== "Enter" && event.key !== " ") {
                    return;
                }
                const highlight = event.target.closest?.(".highlight-annotation");
                if (!highlight) {
                    return;
                }
                event.preventDefault();
                hideHighlightToolbar();
                toggleAnnotationPopover(highlight);
            });
        }

        window.addEventListener("scroll", () => {
            hideHighlightToolbar();
            hideAnnotationPopover();
            closeAnnotationComposer();
        }, true);

        window.addEventListener("resize", () => {
            hideHighlightToolbar();
            hideAnnotationPopover();
            closeAnnotationComposer();
        });
        function generateNoteId() {
            return `note-${Date.now().toString(36)}-${Math.random().toString(36).slice(2, 8)}`;
        }

        function createColorPicker(currentColor, onChange) {
            const palette = document.createElement("div");
            palette.className = "textbox-color-picker";
            palette.setAttribute("role", "group");
            palette.setAttribute("aria-label", "Change text box colour");
            const swatches = [];
            const updateSelection = (selectedColor) => {
                swatches.forEach((button) => {
                    const isActive = button.dataset.value === selectedColor;
                    button.classList.toggle("is-selected", isActive);
                    button.setAttribute("aria-pressed", isActive ? "true" : "false");
                });
            };
            textboxColorOptions.forEach((option) => {
                const swatchButton = document.createElement("button");
                swatchButton.type = "button";
                swatchButton.className = "textbox-color-picker__swatch";
                swatchButton.dataset.value = option.value;
                swatchButton.style.setProperty("--swatch-color", option.value);
                swatchButton.setAttribute("aria-label", option.label);
                swatchButton.title = option.label;
                swatchButton.setAttribute("aria-pressed", "false");
                swatchButton.addEventListener("click", () => {
                    if (typeof onChange === "function") {
                        onChange(option.value);
                    }
                    updateSelection(option.value);
                });
                palette.appendChild(swatchButton);
                swatches.push(swatchButton);
            });
            updateSelection(currentColor);
            return palette;
        }

        function getSlideLabel(slide, index) {
            const rawTitle = slide?.querySelector(".slide-title")?.textContent?.trim() || "";
            const label = rawTitle ? `${rawTitle}` : "";
            const prefix = `Slide ${index + 1}`;
            return label ? `${prefix}: ${label}` : prefix;
        }

        function isValidNotesData(data) {
            if (!data || typeof data !== "object" || Array.isArray(data)) {
                return false;
            }
            return Object.values(data).every((value) => Array.isArray(value) && value.every((note) => {
                return note && typeof note === "object" && "id" in note && "color" in note && ("content" in note || "text" in note);
            }));
        }

        function getStorageKey() {
            const suffix = activeLesson?.id ? `:${activeLesson.id}` : "";
            return `${storageKeyBase}${suffix}`;
        }

        function loadStoredNotes() {
            if (typeof window === "undefined" || !window.localStorage) {
                return {};
            }
            const stored = window.localStorage.getItem(getStorageKey());
            if (!stored) {
                return {};
            }
            try {
                const parsed = JSON.parse(stored);
                return isValidNotesData(parsed) ? parsed : {};
            } catch (error) {
                console.warn("Unable to parse stored slide notes.", error);
                return {};
            }
        }

        function persistNotes() {
            if (typeof window === "undefined" || !window.localStorage) {
                return;
            }
            try {
                window.localStorage.setItem(getStorageKey(), JSON.stringify(slideNotes));
            } catch (error) {
                console.warn("Unable to save slide notes.", error);
            }
        }

        function buildSlideMap() {
            if (!slideMapList) {
                return;
            }
            slideMapList.innerHTML = "";
            slideMapButtons.length = 0;
            slideMapList.setAttribute("role", "list");

            const slideMeta = slides.map((slide, index) => ({
                slide,
                index,
                id: slide.id || `slide-${index + 1}`,
                key: slide.dataset.slideKey || slide.id || `slide-${index + 1}`
            }));
            const slidesByKey = new Map(slideMeta.map((meta) => [meta.key, meta]));
            const usedIndices = new Set();
            const sectionDefinitions = Array.isArray(activeLesson?.sections) ? activeLesson.sections : [];

            const createSlideMapEntry = (slide, index) => {
                const listItem = document.createElement("li");
                listItem.className = "slide-map-item";

                const button = document.createElement("button");
                button.type = "button";
                button.className = "slide-map-button";
                const slideNumber = index + 1;
                const rawTitle = slide?.querySelector(".slide-title")?.textContent?.trim() || "";
                const cleanTitle = rawTitle.replace(/\s+/g, " ").trim();
                const colonIndex = cleanTitle.indexOf(":");
                const mainTitle = colonIndex > -1 ? cleanTitle.slice(0, colonIndex).trim() : cleanTitle;
                const subtitle = colonIndex > -1 ? cleanTitle.slice(colonIndex + 1).trim() : "";

                const numberSpan = document.createElement("span");
                numberSpan.className = "slide-map-button__number";
                numberSpan.textContent = slideNumber.toString().padStart(2, "0");

                const label = document.createElement("span");
                label.className = "slide-map-button__label";

                const titleSpan = document.createElement("span");
                titleSpan.className = "slide-map-button__title";
                titleSpan.textContent = mainTitle || `Slide ${slideNumber}`;
                label.appendChild(titleSpan);

                if (subtitle) {
                    const subtitleSpan = document.createElement("span");
                    subtitleSpan.className = "slide-map-button__subtitle";
                    subtitleSpan.textContent = subtitle;
                    label.appendChild(subtitleSpan);
                }

                const ariaLabelParts = [`Slide ${slideNumber}`];
                if (cleanTitle) {
                    ariaLabelParts.push(cleanTitle);
                }
                button.setAttribute("aria-label", `Go to ${ariaLabelParts.join(": ")}`);
                button.dataset.slideIndex = index;
                button.appendChild(numberSpan);
                button.appendChild(label);
                button.addEventListener("click", () => showSlide(index));

                listItem.appendChild(button);
                return { listItem, button };
            };

            const appendSection = (title, entries) => {
                if (!entries.length) {
                    return;
                }
                const sectionItem = document.createElement("li");
                sectionItem.className = "slide-map-group";

                const sectionTitle = document.createElement("h3");
                sectionTitle.className = "slide-map-group__title";
                sectionTitle.textContent = title;
                sectionItem.appendChild(sectionTitle);

                const sectionList = document.createElement("ol");
                sectionList.className = "slide-map-group__list";
                sectionList.setAttribute("role", "list");

                entries.forEach(({ slide, index }) => {
                    const { listItem, button } = createSlideMapEntry(slide, index);
                    sectionList.appendChild(listItem);
                    slideMapButtons.push(button);
                    usedIndices.add(index);
                });

                sectionItem.appendChild(sectionList);
                slideMapList.appendChild(sectionItem);
            };

            sectionDefinitions.forEach((section) => {
                let entries = [];
                if (Array.isArray(section.slideKeys)) {
                    entries = section.slideKeys.map((key) => slidesByKey.get(key)).filter(Boolean);
                } else if (Array.isArray(section.slideIndices)) {
                    entries = section.slideIndices.map((i) => slideMeta[i]).filter(Boolean);
                } else if (section.range && Array.isArray(section.range) && section.range.length === 2) {
                    entries = slideMeta.filter((meta) => meta.index >= section.range[0] && meta.index <= section.range[1]);
                }
                appendSection(section.title || "Slides", entries);
            });

            const remainingEntries = slideMeta.filter((meta) => !usedIndices.has(meta.index));
            if (remainingEntries.length) {
                appendSection("Additional slides", remainingEntries);
            }

            updateSlideMapIndicator(currentSlideIndex);
        }

        function updateSlideMapIndicator(index) {
            if (!slideMapButtons.length) {
                return;
            }
            slideMapButtons.forEach((button, buttonIndex) => {
                const listItem = button.parentElement;
                const isActive = buttonIndex === index;
                if (listItem) {
                    listItem.classList.toggle("is-active", isActive);
                }
                if (isActive) {
                    button.setAttribute("aria-current", "step");
                    if (listItem && typeof listItem.scrollIntoView === "function") {
                        try {
                            listItem.scrollIntoView({ behavior: prefersReducedMotion ? "auto" : "smooth", block: "nearest", inline: "nearest" });
                        } catch (error) {
                            if (!prefersReducedMotion) {
                                listItem.scrollIntoView();
                            }
                        }
                    }
                } else {
                    button.removeAttribute("aria-current");
                }
            });
        }

        function animateSlideContents(slide) {
            const elementsToAnimate = slide.querySelectorAll(".animate-on-scroll");
            elementsToAnimate.forEach((el, index) => {
                if (prefersReducedMotion) {
                    el.style.opacity = "1";
                    el.classList.remove("animate__animated", "animate__fadeInUp");
                    return;
                }
                el.classList.remove("animate__animated", "animate__fadeInUp");
                el.style.opacity = "0";
                void el.offsetWidth;
                setTimeout(() => {
                    el.classList.add("animate__animated", "animate__fadeInUp");
                    el.style.opacity = "1";
                }, index * 160);
            });
        }

        function handleKeyboardNavigation(event) {
            if (event.defaultPrevented) {
                return;
            }
            const target = event.target;
            const isFormField = target && (
                target.isContentEditable ||
                ["INPUT", "TEXTAREA", "SELECT", "BUTTON"].includes(target.tagName)
            );
            if (isFormField) {
                return;
            }
            if (event.key === "ArrowRight" || event.key === "PageDown") {
                event.preventDefault();
                nextSlide();
            } else if (event.key === "ArrowLeft" || event.key === "PageUp") {
                event.preventDefault();
                prevSlide();
            } else if (event.key === "Home") {
                event.preventDefault();
                showSlide(0);
            } else if (event.key === "End") {
                event.preventDefault();
                showSlide(slides.length - 1);
            }
        }
        function renderSlideTextboxes(slideId) {
            const container = textboxContainers[slideId];
            if (!container) {
                return;
            }
            container.innerHTML = "";
            const notes = Array.isArray(slideNotes[slideId]) ? slideNotes[slideId] : [];
            const panel = notesPanels[slideId];
            if (panel) {
                panel.classList.toggle("empty", notes.length === 0);
            }
            notes.forEach((note) => {
                if (!note.content && note.text) {
                    note.content = note.text;
                    delete note.text;
                }
                container.appendChild(createTextboxElement(slideId, note));
            });
        }

        function renderAllSlides() {
            if (!slides.length) {
                setupNotesIoControls();
                return;
            }
            if (!notesPanelsHost) {
                return;
            }
            slides.forEach((slide, index) => {
                const slideId = slide.dataset.slideId || slide.id || `slide-${index + 1}`;
                if (!Array.isArray(slideNotes[slideId])) {
                    slideNotes[slideId] = [];
                }
                renderSlideTextboxes(slideId);
            });
            const activeSlide = slides[currentSlideIndex];
            if (activeSlide) {
                activateNotesPanel(activeSlide.dataset.slideId);
            }
        }

        function activateNotesPanel(slideId) {
            Object.values(notesPanels).forEach((panel) => {
                panel.classList.remove("active");
                panel.setAttribute("aria-hidden", "true");
                panel.hidden = true;
            });
            const panel = notesPanels[slideId];
            if (panel) {
                panel.classList.add("active");
                panel.setAttribute("aria-hidden", "false");
                panel.hidden = false;
                if (notesPanelsHost) {
                    notesPanelsHost.scrollTop = 0;
                }
            }
        }

        function createTextboxElement(slideId, note) {
            const wrapper = document.createElement("div");
            wrapper.className = "custom-textbox";
            wrapper.dataset.noteId = note.id;
            wrapper.style.backgroundColor = note.color;

            const actions = document.createElement("div");
            actions.className = "textbox-actions";

            const colorPicker = createColorPicker(note.color, (newColor) => {
                if (!newColor || note.color === newColor) {
                    return;
                }
                note.color = newColor;
                wrapper.style.backgroundColor = newColor;
                persistNotes();
            });

            const removeButton = document.createElement("button");
            removeButton.type = "button";
            removeButton.className = "textbox-remove-btn";
            removeButton.innerHTML = '<i class="fas fa-trash"></i> Remove';
            removeButton.addEventListener("click", () => {
                slideNotes[slideId] = (slideNotes[slideId] || []).filter((existing) => existing.id !== note.id);
                persistNotes();
                renderSlideTextboxes(slideId);
            });

            actions.appendChild(colorPicker);
            actions.appendChild(removeButton);

            const content = document.createElement("div");
            content.className = "textbox-content";
            content.contentEditable = "true";
            content.dataset.placeholder = "Type your notes here...";
            content.innerHTML = note.content || "";
            content.addEventListener("input", () => {
                note.content = content.innerHTML;
                persistNotes();
            });

            wrapper.appendChild(actions);
            wrapper.appendChild(content);
            return wrapper;
        }

        function setupNotesIoControls() {
            const saveButton = document.getElementById("save-notes-btn");
            const loadButton = document.getElementById("load-notes-btn");
            const fileInput = document.getElementById("notes-file-input");

            if (saveButton && !saveButton.dataset.initialized) {
                saveButton.addEventListener("click", () => {
                    const data = JSON.stringify(slideNotes, null, 2);
                    const blob = new Blob([data], { type: "application/json" });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement("a");
                    link.href = url;
                    const fileId = activeLesson?.id ? activeLesson.id : "lesson";
                    link.download = `${fileId}-slide-notes.json`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                });
                saveButton.dataset.initialized = "true";
            }

            if (loadButton && !loadButton.dataset.initialized) {
                loadButton.addEventListener("click", () => fileInput?.click());
                loadButton.dataset.initialized = "true";
            }

            if (fileInput && !fileInput.dataset.initialized) {
                fileInput.addEventListener("change", (event) => {
                    const file = event.target.files && event.target.files[0];
                    if (!file) {
                        return;
                    }
                    const reader = new FileReader();
                    reader.onload = (loadEvent) => {
                        try {
                            const parsed = JSON.parse(loadEvent.target.result);
                            if (isValidNotesData(parsed)) {
                                slideNotes = parsed;
                                slides.forEach((slide, index) => {
                                    const slideId = slide.dataset.slideId || slide.id || `slide-${index + 1}`;
                                    if (!Array.isArray(slideNotes[slideId])) {
                                        slideNotes[slideId] = [];
                                    }
                                });
                                persistNotes();
                                renderAllSlides();
                            } else {
                                alert("The selected file does not contain valid notes data.");
                            }
                        } catch (error) {
                            alert("Unable to read that JSON file. Please check the format and try again.");
                        }
                    };
                    reader.onerror = () => {
                        alert("We could not read that file. Please try again with a different JSON export.");
                    };
                    reader.readAsText(file);
                    event.target.value = "";
                });
                fileInput.dataset.initialized = "true";
            }
        }

        function initializeTextboxes() {
            notesPanelsHost = document.getElementById("notes-panels");
            if (!notesPanelsHost) {
                setupNotesIoControls();
                return;
            }

            notesPanelsHost.innerHTML = "";
            for (const key of Object.keys(textboxContainers)) {
                delete textboxContainers[key];
            }
            for (const key of Object.keys(notesPanels)) {
                delete notesPanels[key];
            }

            slides.forEach((slide, index) => {
                const slideId = slide.id || `slide-${index + 1}`;
                slide.dataset.slideId = slideId;
                if (!Array.isArray(slideNotes[slideId])) {
                    slideNotes[slideId] = [];
                }

                const panel = document.createElement("section");
                panel.className = "notes-panel empty";
                panel.dataset.slideId = slideId;
                panel.setAttribute("aria-hidden", "true");
                panel.hidden = true;

                const heading = document.createElement("h3");
                heading.className = "notes-panel-title visually-hidden";
                const headingId = `notes-panel-title-${slideId}`;
                heading.id = headingId;
                heading.textContent = getSlideLabel(slide, index);
                panel.setAttribute("aria-labelledby", headingId);

                const toolbar = document.createElement("div");
                toolbar.className = "textbox-toolbar";

                const toolbarCaption = document.createElement("p");
                toolbarCaption.className = "toolbar-caption visually-hidden";
                toolbarCaption.textContent = "Add a new text box by choosing a colour.";

                const swatchGroup = document.createElement("div");
                swatchGroup.className = "textbox-swatch-group";

                textboxColorOptions.forEach((option) => {
                    const swatchButton = document.createElement("button");
                    swatchButton.type = "button";
                    swatchButton.className = "textbox-swatch";
                    swatchButton.style.setProperty("--swatch-color", option.value);
                    swatchButton.setAttribute("aria-label", `Add a ${option.label} text box`);
                    swatchButton.title = option.label;
                    swatchButton.addEventListener("click", () => {
                        const newNote = { id: generateNoteId(), color: option.value, content: "" };
                        slideNotes[slideId].push(newNote);
                        persistNotes();
                        renderSlideTextboxes(slideId);
                        const latestTextbox = textboxContainers[slideId]?.lastElementChild?.querySelector(".textbox-content");
                        if (latestTextbox) {
                            latestTextbox.focus();
                        }
                    });
                    swatchGroup.appendChild(swatchButton);
                });

                toolbar.appendChild(toolbarCaption);
                toolbar.appendChild(swatchGroup);

                const collection = document.createElement("div");
                collection.className = "textbox-collection";
                textboxContainers[slideId] = collection;

                panel.appendChild(heading);
                panel.appendChild(toolbar);
                panel.appendChild(collection);

                notesPanelsHost.appendChild(panel);
                notesPanels[slideId] = panel;

                renderSlideTextboxes(slideId);
            });

            setupNotesIoControls();
        }
        function createIconHeading(icon, text) {
            const heading = document.createElement("h1");
            heading.className = "slide-title";
            if (icon) {
                heading.innerHTML = `<i class="${icon}"></i> ${text}`;
            } else {
                heading.textContent = text;
            }
            return heading;
        }

        function createRubric(text) {
            const rubric = document.createElement("h2");
            rubric.className = "rubric";
            rubric.textContent = text;
            return rubric;
        }

        function createImageElement(image) {
            if (!image || !image.src) {
                return null;
            }
            const img = document.createElement("img");
            img.src = image.src;
            img.alt = image.alt || "";
            return img;
        }

        function createParagraph(text) {
            const paragraph = document.createElement("p");
            paragraph.textContent = text;
            paragraph.classList.add("animate-on-scroll");
            return paragraph;
        }

        function createListElement(items = [], style = "bullets") {
            if (!Array.isArray(items) || !items.length) {
                return null;
            }
            const list = document.createElement("ul");
            list.className = "slide-list";
            if (style === "smart") {
                list.classList.add("smart");
            }
            items.forEach((item) => {
                const li = document.createElement("li");
                li.classList.add("animate-on-scroll");
                if (style === "smart" && item && typeof item === "object" && item.letter) {
                    li.dataset.letter = item.letter;
                }
                if (typeof item === "string") {
                    li.textContent = item;
                } else if (item && typeof item === "object") {
                    const fragments = [];
                    if (item.icon) {
                        fragments.push(`<i class="${item.icon}"></i>`);
                    }
                    if (item.strong) {
                        fragments.push(`<strong>${item.strong}</strong>`);
                    }
                    if (item.text) {
                        fragments.push(item.text);
                    }
                    li.innerHTML = fragments.join(" ");
                }
                list.appendChild(li);
            });
            return list;
        }

        function renderHeroSlide(slideElement, config) {
            if (config.image) {
                const wrapper = document.createElement("div");
                wrapper.className = "animate-on-scroll";
                const img = createImageElement(config.image);
                if (img) {
                    wrapper.appendChild(img);
                    slideElement.appendChild(wrapper);
                }
            }
            if (config.title) {
                const wrapper = document.createElement("div");
                wrapper.className = "animate-on-scroll";
                wrapper.appendChild(createIconHeading(config.icon, config.title));
                slideElement.appendChild(wrapper);
            }
            if (config.subtitle) {
                const wrapper = document.createElement("div");
                wrapper.className = "animate-on-scroll";
                wrapper.appendChild(createRubric(config.subtitle));
                slideElement.appendChild(wrapper);
            }
        }

        function renderContentSlide(slideElement, config) {
            if (config.title) {
                const headingWrapper = document.createElement("div");
                headingWrapper.className = "animate-on-scroll";
                headingWrapper.appendChild(createIconHeading(config.icon, config.title));
                slideElement.appendChild(headingWrapper);
            }
            if (config.subtitle) {
                const rubricWrapper = document.createElement("div");
                rubricWrapper.className = "animate-on-scroll";
                rubricWrapper.appendChild(createRubric(config.subtitle));
                slideElement.appendChild(rubricWrapper);
            }
            const content = document.createElement("div");
            content.className = "slide-content";
            if (config.image) {
                const img = createImageElement(config.image);
                if (img) {
                    img.classList.add("animate-on-scroll");
                    content.appendChild(img);
                }
            }
            (config.body || []).forEach((paragraph) => {
                content.appendChild(createParagraph(paragraph));
            });
            const list = createListElement(config.list, config.listStyle);
            if (list) {
                content.appendChild(list);
            }
            slideElement.appendChild(content);
        }

        function renderCardsSlide(slideElement, config) {
            if (config.title) {
                const headingWrapper = document.createElement("div");
                headingWrapper.className = "animate-on-scroll";
                headingWrapper.appendChild(createIconHeading(config.icon, config.title));
                slideElement.appendChild(headingWrapper);
            }
            if (config.subtitle) {
                const rubricWrapper = document.createElement("div");
                rubricWrapper.className = "animate-on-scroll";
                rubricWrapper.appendChild(createRubric(config.subtitle));
                slideElement.appendChild(rubricWrapper);
            }
            const content = document.createElement("div");
            content.className = "slide-content card-container";
            (config.cards || []).forEach((cardConfig) => {
                const card = document.createElement("div");
                card.className = "card animate-on-scroll";
                if (cardConfig.icon) {
                    const icon = document.createElement("div");
                    icon.className = "icon";
                    icon.innerHTML = `<i class="${cardConfig.icon}"></i>`;
                    card.appendChild(icon);
                }
                if (cardConfig.title) {
                    const title = document.createElement("h3");
                    title.textContent = cardConfig.title;
                    card.appendChild(title);
                }
                if (cardConfig.description) {
                    const description = document.createElement("p");
                    description.textContent = cardConfig.description;
                    card.appendChild(description);
                }
                content.appendChild(card);
            });
            slideElement.appendChild(content);
        }

        function renderStorySlide(slideElement, config) {
            if (config.title) {
                const headingWrapper = document.createElement("div");
                headingWrapper.className = "animate-on-scroll";
                headingWrapper.appendChild(createIconHeading(config.icon, config.title));
                slideElement.appendChild(headingWrapper);
            }
            if (config.quote) {
                const rubricWrapper = document.createElement("div");
                rubricWrapper.className = "animate-on-scroll";
                rubricWrapper.appendChild(createRubric(config.quote));
                slideElement.appendChild(rubricWrapper);
            }
            const content = document.createElement("div");
            content.className = "slide-content";
            if (config.image) {
                const img = createImageElement(config.image);
                if (img) {
                    img.classList.add("animate-on-scroll");
                    content.appendChild(img);
                }
            }
            if (config.process) {
                const paragraph = document.createElement("p");
                paragraph.className = "animate-on-scroll";
                const strong = document.createElement("strong");
                strong.textContent = config.process.label || "Process:";
                paragraph.appendChild(strong);
                paragraph.appendChild(document.createTextNode(` ${config.process.text || ""}`));
                content.appendChild(paragraph);
            }
            if (config.outcome) {
                const paragraph = document.createElement("p");
                paragraph.className = "animate-on-scroll";
                const strong = document.createElement("strong");
                strong.textContent = config.outcome.label || "Outcome:";
                paragraph.appendChild(strong);
                paragraph.appendChild(document.createTextNode(` ${config.outcome.text || ""}`));
                content.appendChild(paragraph);
            }
            slideElement.appendChild(content);
        }

        function renderProcessSlide(slideElement, config) {
            if (config.title) {
                const headingWrapper = document.createElement("div");
                headingWrapper.className = "animate-on-scroll";
                headingWrapper.appendChild(createIconHeading(config.icon, config.title));
                slideElement.appendChild(headingWrapper);
            }
            if (config.subtitle) {
                const rubricWrapper = document.createElement("div");
                rubricWrapper.className = "animate-on-scroll";
                rubricWrapper.appendChild(createRubric(config.subtitle));
                slideElement.appendChild(rubricWrapper);
            }
            const content = document.createElement("div");
            content.className = "slide-content";
            if (config.image) {
                const img = createImageElement(config.image);
                if (img) {
                    img.classList.add("animate-on-scroll");
                    content.appendChild(img);
                }
            }
            (config.body || []).forEach((paragraph) => {
                content.appendChild(createParagraph(paragraph));
            });
            const flow = document.createElement("div");
            flow.className = "process-flow";
            (config.steps || []).forEach((step, index) => {
                const stepElement = document.createElement("div");
                stepElement.className = "process-step animate-on-scroll";

                const number = document.createElement("div");
                number.className = "process-step-number";
                number.textContent = step.number ? String(step.number) : String(index + 1);
                stepElement.appendChild(number);

                const stepContent = document.createElement("div");
                stepContent.className = "process-step-content";
                if (step.title) {
                    const strong = document.createElement("strong");
                    strong.textContent = step.title;
                    stepContent.appendChild(strong);
                }
                if (step.description) {
                    const paragraph = document.createElement("p");
                    paragraph.textContent = step.description;
                    stepContent.appendChild(paragraph);
                }
                stepElement.appendChild(stepContent);
                flow.appendChild(stepElement);
            });
            content.appendChild(flow);
            slideElement.appendChild(content);
        }

        function renderQuizSlide(slideElement, config) {
            if (config.title) {
                const headingWrapper = document.createElement("div");
                headingWrapper.className = "animate-on-scroll";
                headingWrapper.appendChild(createIconHeading(config.icon, config.title));
                slideElement.appendChild(headingWrapper);
            }
            const content = document.createElement("div");
            content.className = "slide-content";
            (config.questions || []).forEach((question) => {
                const card = document.createElement("div");
                card.className = "quiz-card animate-on-scroll";

                const prompt = document.createElement("p");
                prompt.className = "quiz-question-text";
                prompt.textContent = question.prompt;
                card.appendChild(prompt);

                const optionsContainer = document.createElement("div");
                optionsContainer.className = "quiz-options";
                const groupName = question.id;
                const feedbackId = question.feedbackId || `${groupName}-feedback`;

                (question.options || []).forEach((option, index) => {
                    const label = document.createElement("label");
                    label.className = "quiz-option";

                    const input = document.createElement("input");
                    input.type = "radio";
                    input.name = groupName;
                    input.value = option.value;
                    input.id = `${groupName}-option-${index}`;

                    const span = document.createElement("span");
                    span.textContent = option.label;

                    label.appendChild(input);
                    label.appendChild(span);
                    optionsContainer.appendChild(label);
                });

                card.appendChild(optionsContainer);

                const button = document.createElement("button");
                button.type = "button";
                button.className = "activity-btn quiz-btn";
                button.textContent = "Check Answer";
                button.addEventListener("click", () => {
                    checkSingleChoice(groupName, feedbackId, question.answer, question.correctFeedback, question.incorrectFeedback);
                });
                card.appendChild(button);

                const feedback = document.createElement("p");
                feedback.className = "quiz-feedback";
                feedback.id = feedbackId;
                card.appendChild(feedback);

                content.appendChild(card);
            });
            slideElement.appendChild(content);
        }

        function renderReflectionSlide(slideElement, config) {
            if (config.title) {
                const headingWrapper = document.createElement("div");
                headingWrapper.className = "animate-on-scroll";
                headingWrapper.appendChild(createIconHeading(config.icon, config.title));
                slideElement.appendChild(headingWrapper);
            }
            if (config.subtitle) {
                const rubricWrapper = document.createElement("div");
                rubricWrapper.className = "animate-on-scroll";
                rubricWrapper.appendChild(createRubric(config.subtitle));
                slideElement.appendChild(rubricWrapper);
            }
            const content = document.createElement("div");
            content.className = "slide-content reflection-form";
            (config.fields || []).forEach((field, index) => {
                const wrapper = document.createElement("div");
                wrapper.className = "reflection-field animate-on-scroll";

                const label = document.createElement("label");
                const fieldId = field.id || `reflection-field-${index}`;
                label.setAttribute("for", fieldId);
                label.textContent = field.label || "Reflection";

                const textarea = document.createElement("textarea");
                textarea.id = fieldId;
                textarea.placeholder = field.placeholder || "";

                wrapper.appendChild(label);
                wrapper.appendChild(textarea);
                content.appendChild(wrapper);
            });
            slideElement.appendChild(content);
        }
        function createNavigationControls(index, total, config) {
            const navConfig = config?.nav || {};
            const controls = document.createElement("div");
            controls.className = "controls animate-on-scroll";
            let buttonsAdded = 0;

            const showPrev = !navConfig.hidePrev && index > 0;
            if (showPrev) {
                const prevButton = document.createElement("button");
                prevButton.type = "button";
                prevButton.className = "activity-btn secondary";
                const prevLabel = navConfig.prevLabel || "Back";
                const prevIcon = navConfig.prevIcon || "fas fa-arrow-left";
                prevButton.innerHTML = `<i class="${prevIcon}"></i> ${prevLabel}`;
                prevButton.addEventListener("click", () => {
                    prevSlide();
                });
                controls.appendChild(prevButton);
                buttonsAdded += 1;
            }

            const isLastSlide = index === total - 1;
            const hideNext = navConfig.hideNext || false;
            if (!hideNext) {
                const nextButton = document.createElement("button");
                nextButton.type = "button";
                const nextVariant = navConfig.nextVariant === "secondary" ? "secondary" : "";
                nextButton.className = `activity-btn ${nextVariant}`.trim();
                const nextAction = navConfig.nextAction || (isLastSlide ? "restart" : "next");
                const nextLabel = navConfig.nextLabel || (isLastSlide ? "Finish & Restart" : "Next");
                const nextIcon = navConfig.nextIcon || (isLastSlide ? "fas fa-check" : "fas fa-arrow-right");
                nextButton.innerHTML = nextVariant === "secondary"
                    ? `${nextLabel}`
                    : `${nextLabel} <i class="${nextIcon}"></i>`;
                nextButton.addEventListener("click", () => {
                    if (nextAction === "restart") {
                        showSlide(0);
                    } else {
                        nextSlide();
                    }
                });
                controls.appendChild(nextButton);
                buttonsAdded += 1;
            }

            if (!buttonsAdded) {
                return null;
            }
            return controls;
        }

        function buildSlideElement(config, index, total) {
            const slideElement = document.createElement("div");
            slideElement.className = "screen";
            slideElement.id = `slide-${index + 1}`;
            slideElement.dataset.slideKey = config.key || slideElement.id;

            switch (config.type) {
                case "hero":
                    renderHeroSlide(slideElement, config);
                    break;
                case "cards":
                    renderCardsSlide(slideElement, config);
                    break;
                case "story":
                    renderStorySlide(slideElement, config);
                    break;
                case "process":
                    renderProcessSlide(slideElement, config);
                    break;
                case "quiz":
                    renderQuizSlide(slideElement, config);
                    break;
                case "reflection":
                    renderReflectionSlide(slideElement, config);
                    break;
                case "content":
                default:
                    renderContentSlide(slideElement, config);
                    break;
            }

            const controls = createNavigationControls(index, total, config);
            if (controls) {
                slideElement.appendChild(controls);
            }
            return slideElement;
        }

        function renderSlidesFromLesson(lesson) {
            if (!slidesRoot) {
                return;
            }
            slidesRoot.innerHTML = "";
            const slideConfigs = Array.isArray(lesson?.slides) ? lesson.slides : [];
            slideConfigs.forEach((config, index) => {
                const slideElement = buildSlideElement(config, index, slideConfigs.length);
                slidesRoot.appendChild(slideElement);
            });
            slides = Array.from(slidesRoot.querySelectorAll(".screen"));
        }

        function renderLesson(lessonKey) {
            const availableLessons = Object.keys(lessonLibrary);
            if (!availableLessons.length) {
                return;
            }
            const resolvedKey = lessonLibrary[lessonKey] ? lessonKey : availableLessons[0];
            const lesson = lessonLibrary[resolvedKey];
            if (!lesson) {
                return;
            }
            activeLessonKey = resolvedKey;
            activeLesson = lesson;

            if (presentationEyebrow) {
                presentationEyebrow.textContent = lesson.meta?.eyebrow || lesson.label || "Instructional Session";
            }
            if (presentationDescriptor) {
                presentationDescriptor.textContent = lesson.meta?.descriptor || "Choose a template to populate the slides.";
            }
            if (typeof document !== "undefined") {
                const fallbackTitle = `${lesson.label || "Lesson"} â€“ Instructional Slides`;
                document.title = lesson.meta?.pageTitle || fallbackTitle;
            }

            hideHighlightToolbar();
            hideAnnotationPopover();
            closeAnnotationComposer();

            renderSlidesFromLesson(lesson);
            currentSlideIndex = 0;
            slideNotes = loadStoredNotes();
            initializeTextboxes();
            renderAllSlides();
            buildSlideMap();
            showSlide(0);

            if (lessonSelector && lessonSelector.value !== resolvedKey) {
                lessonSelector.value = resolvedKey;
            }
        }

        function populateLessonSelector() {
            if (!lessonSelector) {
                return;
            }
            if (!lessonSelector.dataset.initialized) {
                lessonSelector.addEventListener("change", (event) => {
                    renderLesson(event.target.value);
                });
                lessonSelector.dataset.initialized = "true";
            }
            lessonSelector.innerHTML = "";
            Object.entries(lessonLibrary).forEach(([key, lesson]) => {
                const option = document.createElement("option");
                option.value = key;
                option.textContent = lesson.label || key;
                lessonSelector.appendChild(option);
            });
        }

        function attachKeyboardNavigation() {
            if (keyboardHandlerAttached) {
                return;
            }
            try {
                document.addEventListener("keydown", handleKeyboardNavigation, { passive: false });
            } catch (error) {
                document.addEventListener("keydown", handleKeyboardNavigation);
            }
            keyboardHandlerAttached = true;
        }

        function showSlide(index) {
            if (!Number.isInteger(index) || index < 0 || index >= slides.length) {
                return;
            }
            slides.forEach((slide, i) => {
                slide.classList.toggle("active", i === index);
            });
            currentSlideIndex = index;
            hideHighlightToolbar();
            hideAnnotationPopover();
            const activeSlide = slides[index];
            if (activeSlide) {
                animateSlideContents(activeSlide);
                activateNotesPanel(activeSlide.dataset.slideId);
            }
            updateSlideMapIndicator(index);
        }

        function nextSlide() {
            if (currentSlideIndex < slides.length - 1) {
                showSlide(currentSlideIndex + 1);
            }
        }

        function prevSlide() {
            if (currentSlideIndex > 0) {
                showSlide(currentSlideIndex - 1);
            }
        }

        function updateQuizFeedback(feedbackId, message, status) {
            const feedback = document.getElementById(feedbackId);
            if (!feedback) {
                return;
            }
            feedback.textContent = message;
            feedback.classList.remove("correct", "incorrect", "notice");
            feedback.classList.add(status);
        }

        function checkSingleChoice(groupName, feedbackId, correctValue, successMessage, errorMessage) {
            const selected = document.querySelector(`input[name="${groupName}"]:checked`);
            if (!selected) {
                updateQuizFeedback(feedbackId, "Please choose an option before checking your answer.", "notice");
                return;
            }
            if (selected.value === correctValue) {
                updateQuizFeedback(feedbackId, successMessage, "correct");
            } else {
                updateQuizFeedback(feedbackId, errorMessage, "incorrect");
            }
        }

        document.addEventListener("DOMContentLoaded", () => {
            populateLessonSelector();
            const defaultLessonKey = lessonSelector?.value || Object.keys(lessonLibrary)[0];
            renderLesson(defaultLessonKey);
            attachKeyboardNavigation();
            const notesPanel = document.getElementById("notes-io-controls");
            if (notesPanel) {
                notesPanel.classList.add("animate__animated", "animate__fadeInDown");
                notesPanel.style.opacity = "1";
            }
        });
    </script>

</body>
</html>
